<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title | default(value="Dashboard") }} — Velocty Admin</title>
    <link rel="stylesheet" href="/static/css/admin.css?v=20260222">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    {% block head_extra %}{% endblock head_extra %}
</head>
<body data-theme="{{ settings.admin_theme | default(value='dark') }}">
    <div class="admin-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                {% if settings.admin_theme | default(value='dark') == "light" %}
                <img src="/static/images/logo-v-light.png" alt="V" class="sidebar-icon">
                <img src="/static/images/logo-transparent-light.png" alt="Velocty" class="sidebar-logo-full">
                {% else %}
                <img src="/static/images/logo-v.png" alt="V" class="sidebar-icon">
                <img src="/static/images/logo-transparent.png" alt="Velocty" class="sidebar-logo-full">
                {% endif %}
            </div>
            <nav class="sidebar-nav">
                <a href="/{{ admin_slug }}" class="nav-item {% if page_title == 'Dashboard' %}active{% endif %}" title="Dashboard">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    <span class="nav-label">Dashboard</span>
                </a>
                {% if settings.journal_enabled != "false" %}
                <a href="/{{ admin_slug }}/posts" class="nav-item {% if page_title == 'Journal' or page_title == 'New Post' or page_title == 'Edit Post' %}active{% endif %}" title="Journal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    <span class="nav-label">Journal</span>
                </a>
                {% endif %}
                {% if settings.portfolio_enabled == "true" %}
                <a href="/{{ admin_slug }}/portfolio" class="nav-item {% if page_title == 'Portfolio' or page_title == 'New Portfolio Item' or page_title == 'Edit Portfolio Item' %}active{% endif %}" title="Portfolio">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span class="nav-label">Portfolio</span>
                </a>
                {% endif %}
                <a href="/{{ admin_slug }}/comments" class="nav-item {% if page_title == 'Comments' %}active{% endif %}" title="Comments">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    <span class="nav-label">Comments</span>
                </a>
                <a href="/{{ admin_slug }}/categories" class="nav-item {% if page_title == 'Categories' %}active{% endif %}" title="Categories">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                    <span class="nav-label">Categories</span>
                </a>
                <a href="/{{ admin_slug }}/tags" class="nav-item {% if page_title == 'Tags' %}active{% endif %}" title="Tags">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>
                    <span class="nav-label">Tags</span>
                </a>
                <a href="/{{ admin_slug }}/media" class="nav-item {% if page_title == 'Media' %}active{% endif %}" title="Media">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    <span class="nav-label">Media</span>
                </a>
                <a href="/{{ admin_slug }}/designer" class="nav-item {% if page_title == 'Designer' or page_title == 'Designs' %}active{% endif %}" title="Designer">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><path d="M17.08 8.94a1.5 1.5 0 0 1 0 2.12l-7.07 7.07a1.5 1.5 0 0 1-2.12 0l-4.24-4.24a1.5 1.5 0 0 1 0-2.12l7.07-7.07a1.5 1.5 0 0 1 2.12 0z"/></svg>
                    <span class="nav-label">Designer</span>
                </a>
                <a href="/{{ admin_slug }}/import" class="nav-item {% if page_title == 'Import' %}active{% endif %}" title="Import">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span class="nav-label">Import</span>
                </a>
                <a href="/{{ admin_slug }}/health" class="nav-item {% if page_title == 'Health' %}active{% endif %}" title="Health">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    <span class="nav-label">Health</span>
                </a>
                {% if settings.firewall_enabled == "true" %}
                <a href="/{{ admin_slug }}/firewall" class="nav-item {% if page_title == 'Firewall' %}active{% endif %}" title="Firewall">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    <span class="nav-label">Firewall</span>
                </a>
                {% endif %}
                {% if settings.commerce_paypal_enabled == "true" or settings.commerce_stripe_enabled == "true" or settings.commerce_payoneer_enabled == "true" or settings.commerce_2checkout_enabled == "true" or settings.commerce_square_enabled == "true" or settings.commerce_razorpay_enabled == "true" or settings.commerce_mollie_enabled == "true" %}
                <a href="/{{ admin_slug }}/sales" class="nav-item {% if page_title == 'Sales' or page_title == 'Sales Dashboard' or page_title == 'Orders' %}active{% endif %}" title="Sales">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <span class="nav-label">Sales</span>
                </a>
                {% endif %}
                <a href="/{{ admin_slug }}/users" class="nav-item {% if page_title == 'Users' %}active{% endif %}" title="Users">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span class="nav-label">Users</span>
                </a>
                <a href="/{{ admin_slug }}/settings/general" class="nav-item {% if page_title is containing('Settings') %}active{% endif %}" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    <span class="nav-label">Settings</span>
                </a>
            </nav>
            <div class="sidebar-bottom">
                <a href="/{{ admin_slug }}/seo-audit" class="seo-health-widget" title="Seo Audit">
                    <svg viewBox="0 0 36 36" width="32" height="32" style="transform:rotate(-90deg);flex-shrink:0">
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--text-tertiary)" stroke-width="3" opacity="0.4"/>
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--text-tertiary)" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round" class="seo-ring"/>
                    </svg>
                    <span class="seo-score-label">Seo Audit</span>
                </a>
                <div style="border-top:1px solid var(--border-subtle);margin:4px 12px"></div>
                <div class="sidebar-user-row">
                    <a href="/{{ admin_slug }}/users" title="{{ settings.admin_display_name | default(value='Admin') }}" style="text-decoration:none">
                        <span class="user-avatar">{{ settings.admin_display_name | default(value='A') | truncate(length=1, end='') | upper }}</span>
                    </a>
                    <a href="/{{ admin_slug }}/users" class="nav-label" style="text-decoration:none;color:var(--text-tertiary)">{{ settings.admin_display_name | default(value='Admin') }}</a>
                    <button type="button" class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        {% if settings.admin_theme | default(value='dark') == "light" %}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        {% else %}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        {% endif %}
                    </button>
                </div>
                <a href="/{{ admin_slug }}/logout" class="nav-item" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span class="nav-label">Logout</span>
                </a>
            </div>
        </aside>
        <div class="main-area">
            <header class="top-bar">
                <h2 class="page-title">{{ page_title | default(value="Dashboard") }}</h2>
                <div class="top-bar-right">
                    {% if settings.site_environment | default(value='staging') == "production" %}
                    <span class="env-badge env-prod" title="Production environment">PROD</span>
                    {% else %}
                    <span class="env-badge env-staging" title="Dev / Staging environment">STAGING</span>
                    <button type="button" class="btn btn-sm deploy-btn" id="deploy-btn" onclick="openDeployModal()" title="Deploy to Production">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>Deploy
                    </button>
                    {% endif %}
                </div>
            </header>
            <main class="content-area">
                {% block content %}{% endblock content %}
            </main>
        </div>
    </div>

    {% if settings.site_environment | default(value='staging') != "production" %}
    <!-- Deploy Modal Overlay -->
    <div id="deploy-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9998" onclick="closeDeployModal()"></div>
    <div id="deploy-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:560px;max-width:95vw;max-height:85vh;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:12px;z-index:9999;padding:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0;font-size:16px;color:var(--text-primary)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>Deploy to Production
            </h3>
            <button type="button" onclick="closeDeployModal()" style="background:none;border:none;color:var(--text-tertiary);font-size:20px;cursor:pointer;padding:0 4px">&times;</button>
        </div>

        <!-- Phase 1: Target Selection -->
        <div id="deploy-phase-target">
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Select a production target to deploy your content to.</p>
            <div id="deploy-target-list" style="margin-bottom:16px"></div>
            <div style="text-align:right">
                <button type="button" class="btn btn-secondary" onclick="closeDeployModal()" style="margin-right:8px">Cancel</button>
                <button type="button" class="btn btn-primary" id="deploy-start-btn" onclick="deployStart()" disabled>Deploy</button>
            </div>
        </div>

        <!-- Phase 2: Progress -->
        <div id="deploy-phase-progress" style="display:none">
            <div id="deploy-status-text" style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Connecting...</div>
            <div style="background:var(--bg-input);border-radius:6px;height:8px;overflow:hidden;margin-bottom:8px">
                <div id="deploy-progress-bar" style="height:100%;background:var(--accent);width:0%;transition:width 0.3s;border-radius:6px"></div>
            </div>
            <div id="deploy-progress-detail" style="font-size:11px;color:var(--text-tertiary)"></div>
        </div>

        <!-- Phase 3: Done -->
        <div id="deploy-phase-done" style="display:none">
            <div style="text-align:center;padding:16px 0">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <h4 style="margin:12px 0 4px;color:var(--text-primary)">Deploy Complete</h4>
                <p id="deploy-done-summary" style="font-size:13px;color:var(--text-secondary)"></p>
                <p style="font-size:12px;color:var(--warning);margin-top:8px">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    The deploy key on the target has been rotated. Update your deploy target key in Settings before deploying again.
                </p>
            </div>
            <div style="text-align:right;margin-top:12px">
                <button type="button" class="btn btn-primary" onclick="closeDeployModal()">Close</button>
            </div>
        </div>

        <!-- Phase: Info (no targets, missing config, etc.) -->
        <div id="deploy-phase-info" style="display:none">
            <div style="text-align:center;padding:16px 0">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                <div id="deploy-info-text" style="font-size:13px;color:var(--text-secondary);margin-top:12px"></div>
            </div>
            <div style="text-align:right;margin-top:12px">
                <button type="button" class="btn btn-primary" onclick="closeDeployModal()">Close</button>
            </div>
        </div>

        <!-- Phase: Error -->
        <div id="deploy-phase-error" style="display:none">
            <div style="text-align:center;padding:16px 0">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                <h4 style="margin:12px 0 4px;color:var(--text-primary)">Deploy Failed</h4>
                <p id="deploy-error-text" style="font-size:13px;color:var(--danger)"></p>
            </div>
            <div style="text-align:right;margin-top:12px">
                <button type="button" class="btn btn-primary" onclick="closeDeployModal()">Close</button>
            </div>
        </div>

        <!-- Inline confirm bar (replaces native confirm()) -->
        <div id="deploy-confirm-bar" style="display:none;background:var(--bg-input);border:1px solid var(--warning);border-radius:8px;padding:12px 16px;margin-top:12px">
            <p id="deploy-confirm-msg" style="font-size:13px;color:var(--text-primary);margin:0 0 10px"></p>
            <div style="text-align:right">
                <button type="button" class="btn btn-secondary" id="deploy-confirm-no" style="margin-right:8px">Cancel</button>
                <button type="button" class="btn btn-danger" id="deploy-confirm-yes">Yes, close</button>
            </div>
        </div>
    </div>
    {% endif %}

    {% block scripts %}{% endblock scripts %}
    <script>
    (function(){
        var isMac = /Mac|iPhone|iPad/.test(navigator.platform || navigator.userAgent);
        document.querySelectorAll('.kbd-mod').forEach(function(el){ el.textContent = isMac ? '⌘' : 'Ctrl'; });
        document.addEventListener('keydown', function(e){
            var mod = isMac ? e.metaKey : e.ctrlKey;
            if (!mod) return;
            if (e.key === 's' || e.key === 'S') {
                e.preventDefault();
                if (typeof tinymce !== 'undefined') tinymce.triggerSave();
                var pubBtn = document.querySelector('button[name="status"][value="published"]');
                // Find the right form: 1) visible subtab panel, 2) data-saveable, 3) single form fallback
                var activePanel = null;
                document.querySelectorAll('.subtab-panel').forEach(function(p) { if (p.style.display !== 'none') activePanel = p; });
                var form = activePanel ? activePanel.querySelector('form') : (document.querySelector('form[data-saveable]') || (document.querySelectorAll('form').length === 1 ? document.querySelector('form') : null));
                if (!form) return;
                if (pubBtn) { if (location.hash) form.action = form.action.split('#')[0] + location.hash; pubBtn.click(); }
                else { if (location.hash) form.action = form.action.split('#')[0] + location.hash; form.submit(); }
            }
            if (e.key === 'p' || e.key === 'P') {
                e.preventDefault();
                window.location.href = '/{{ admin_slug }}/posts/new';
            }
            if (e.key === 'i' || e.key === 'I') {
                e.preventDefault();
                window.location.href = '/{{ admin_slug }}/portfolio/new';
            }
        });
    })();
    // Preserve sub-tab hash on form submit
    document.querySelectorAll('form').forEach(function(f){
        f.addEventListener('submit', function(){
            if (location.hash) f.action = f.action.split('#')[0] + location.hash;
        });
    });
    // Theme toggle
    (function(){
        var btn = document.getElementById('theme-toggle');
        if (!btn) return;
        var sunSvg = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
        var moonSvg = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var body = document.body;
            var current = body.getAttribute('data-theme') || 'dark';
            var next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            btn.innerHTML = next === 'light' ? moonSvg : sunSvg;
            btn.title = next === 'light' ? 'Switch to dark' : 'Switch to light';
            var icon = document.querySelector('.sidebar-icon');
            var full = document.querySelector('.sidebar-logo-full');
            if (icon) icon.src = next === 'light' ? '/static/images/logo-v-light.png' : '/static/images/logo-v.png';
            if (full) full.src = next === 'light' ? '/static/images/logo-transparent-light.png' : '/static/images/logo-transparent.png';
            document.querySelectorAll('.theme-logo').forEach(function(el) {
                el.src = next === 'light' ? '/static/images/logo-v-light.png' : '/static/images/logo-v.png';
            });
            fetch('/{{ admin_slug }}/api/theme', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({theme: next})
            });
        });
    })();
    // Convert UTC dates to browser local time
    document.querySelectorAll('.utc-date').forEach(function(el) {
        var raw = el.textContent.trim();
        if (!raw || raw === 'Never' || raw === '-') return;
        var d = new Date(raw.replace(' ', 'T') + 'Z');
        if (isNaN(d)) return;
        var pad = function(n){ return n < 10 ? '0'+n : n; };
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var h = d.getHours(), ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        el.textContent = months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear() + '  ' + h + ':' + pad(d.getMinutes()) + ' ' + ampm;
    });
    // SEO health widget: load score via lightweight API
    (function(){
        var ring = document.querySelector('.seo-ring');
        if (!ring) return;
        var label = document.querySelector('.seo-score-label');
        fetch('/{{ admin_slug }}/api/seo-score', { credentials: 'same-origin' })
            .then(function(r){ return r.json(); })
            .then(function(d){
                var s = d.score;
                if (s < 0) return;
                ring.setAttribute('stroke-dasharray', s + ', 100');
                var c = s >= 80 ? 'var(--success)' : s >= 50 ? 'var(--warning)' : 'var(--danger)';
                ring.setAttribute('stroke', c);
                if (label) label.textContent = 'Seo Audit ' + s;
            })
            .catch(function(){});
    })();
    {% if flash_msg is defined and flash_msg %}
    (function(){
        var el = document.createElement('div');
        el.className = 'alert alert-{{ flash_kind | default(value="info") }} alert-flash';
        var span = document.createElement('span');
        span.textContent = {{ flash_msg | json_encode() | replace(from="</", to="<\\/") | safe }};
        var closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'alert-close';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = function(){ el.remove(); };
        el.appendChild(span);
        el.appendChild(closeBtn);
        var header = document.querySelector('.page-header');
        if (header) header.insertAdjacentElement('afterend', el);
        else { var main = document.querySelector('.content-area'); if (main) main.prepend(el); }
        setTimeout(function(){ if (el.parentElement) { el.style.transition='opacity 0.4s'; el.style.opacity='0'; setTimeout(function(){ el.remove(); },400); } }, 8000);
    })();
    {% endif %}

    {% if settings.site_environment | default(value='staging') != "production" %}
    // ── Deploy Modal Logic ──────────────────────────────────────
    var _deployTargets = [];
    try { _deployTargets = JSON.parse('{{ settings.deploy_targets | default(value="[]") }}'); } catch(e) {}
    var _deploySelected = -1;
    var _deployBusy = false;
    var _deployAbort = null;

    function openDeployModal() {
        document.getElementById('deploy-overlay').style.display = '';
        document.getElementById('deploy-modal').style.display = '';
        if (_deployTargets.length === 0) {
            document.getElementById('deploy-info-text').innerHTML = 'No deploy targets configured.<br><span style="margin-top:6px;display:inline-block">Go to Settings \u2192 Site \u2192 Deploy Targets to add one.</span>';
            deployShowPhase('info');
            return;
        }
        _deploySelected = _deployTargets.length === 1 ? 0 : -1;
        renderDeployTargetPicker();
        deployShowPhase('target');
    }

    function closeDeployModal() {
        if (_deployBusy) {
            // Show inline confirm bar instead of native confirm()
            var bar = document.getElementById('deploy-confirm-bar');
            document.getElementById('deploy-confirm-msg').textContent = 'A deploy is in progress. Items already transferred will remain on the target. Close anyway?';
            bar.style.display = '';
            document.getElementById('deploy-confirm-yes').onclick = function() {
                if (_deployAbort) { _deployAbort.abort(); _deployAbort = null; }
                _deployBusy = false;
                bar.style.display = 'none';
                document.getElementById('deploy-overlay').style.display = 'none';
                document.getElementById('deploy-modal').style.display = 'none';
            };
            document.getElementById('deploy-confirm-no').onclick = function() {
                bar.style.display = 'none';
            };
            return;
        }
        document.getElementById('deploy-confirm-bar').style.display = 'none';
        document.getElementById('deploy-overlay').style.display = 'none';
        document.getElementById('deploy-modal').style.display = 'none';
    }

    function deployShowPhase(phase) {
        ['target','progress','done','error','info'].forEach(function(p) {
            var el = document.getElementById('deploy-phase-' + p);
            if (el) el.style.display = p === phase ? '' : 'none';
        });
    }

    function _escDeploy(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function renderDeployTargetPicker() {
        var list = document.getElementById('deploy-target-list');
        var html = '';
        for (var i = 0; i < _deployTargets.length; i++) {
            var t = _deployTargets[i];
            var sel = i === _deploySelected;
            html += '<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid ' + (sel ? 'var(--accent)' : 'var(--border-subtle)') + ';border-radius:8px;cursor:pointer;margin-bottom:6px;background:' + (sel ? 'var(--bg-input)' : 'transparent') + '" onclick="selectDeployTarget(' + i + ')">';
            html += '<input type="radio" name="deploy_target" ' + (sel ? 'checked' : '') + ' style="margin:0">';
            html += '<div><strong style="color:var(--text-primary)">' + _escDeploy(t.name || 'Unnamed') + '</strong>';
            html += '<div style="font-size:12px;color:var(--text-tertiary)">' + _escDeploy(t.url || 'No URL') + '</div></div></label>';
        }
        list.innerHTML = html;
        document.getElementById('deploy-start-btn').disabled = _deploySelected < 0;
    }

    function selectDeployTarget(i) {
        _deploySelected = i;
        renderDeployTargetPicker();
    }

    async function deployStart() {
        if (_deploySelected < 0) return;
        var target = _deployTargets[_deploySelected];
        if (!target.url || !target.key) {
            document.getElementById('deploy-info-text').innerHTML = 'Selected target is missing a URL or deploy key.<br><span style="margin-top:6px;display:inline-block">Update it in Settings \u2192 Site \u2192 Deploy Targets.</span>';
            deployShowPhase('info');
            return;
        }

        _deployBusy = true;
        _deployAbort = new AbortController();
        deployShowPhase('progress');
        var bar = document.getElementById('deploy-progress-bar');
        var status = document.getElementById('deploy-status-text');
        var detail = document.getElementById('deploy-progress-detail');

        try {
            // Step 1: Preflight check
            status.textContent = 'Running preflight check...';
            bar.style.width = '5%';
            var pfResp;
            try {
                var pfr = await fetch(target.url.replace(/\/+$/, '') + '/api/deploy/preflight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: target.key }),
                    signal: _deployAbort.signal
                });
                pfResp = await pfr.json();
            } catch (e) {
                if (e.name === 'AbortError') return;
                throw new Error('Cannot reach target: ' + e.message);
            }

            if (!pfResp.ok) throw new Error('Preflight failed: ' + (pfResp.error || 'Unknown error'));

            // Environment validation: block staging → staging
            if (pfResp.environment !== 'production') {
                throw new Error('Target "' + (target.name || target.url) + '" is a ' + pfResp.environment + ' instance, not production. Deploy blocked.');
            }

            status.textContent = 'Connected to ' + (pfResp.site_name || target.name) + ' (Production)';
            bar.style.width = '10%';

            // Step 2: Gather local content
            status.textContent = 'Gathering local content...';
            bar.style.width = '15%';
            var gatherResp;
            try {
                var gr = await fetch('/{{ admin_slug }}/api/deploy/gather', { credentials: 'same-origin', signal: _deployAbort.signal });
                gatherResp = await gr.json();
            } catch (e) {
                if (e.name === 'AbortError') return;
                throw new Error('Failed to gather content: ' + e.message);
            }
            if (!gatherResp.ok) throw new Error('Gather failed');

            detail.textContent = gatherResp.total_posts + ' posts, ' + gatherResp.total_portfolio + ' portfolio items, ' + gatherResp.total_uploads + ' uploads';
            bar.style.width = '25%';

            // Step 3: Fetch upload data in chunks and build the bundle
            var uploads = [];
            var uploadPaths = gatherResp.upload_paths || [];
            var CHUNK = 10;
            for (var ci = 0; ci < uploadPaths.length; ci += CHUNK) {
                var batch = uploadPaths.slice(ci, ci + CHUNK);
                status.textContent = 'Reading uploads... (' + Math.min(ci + CHUNK, uploadPaths.length) + '/' + uploadPaths.length + ')';
                var pct = 25 + (ci / Math.max(uploadPaths.length, 1)) * 35;
                bar.style.width = pct + '%';

                var promises = batch.map(function(p) {
                    return fetch('/{{ admin_slug }}/api/deploy/upload-data?path=' + encodeURIComponent(p), { credentials: 'same-origin', signal: _deployAbort.signal })
                        .then(function(r) { return r.json(); });
                });
                var results = await Promise.all(promises);
                for (var ri = 0; ri < results.length; ri++) {
                    if (results[ri].ok) {
                        uploads.push({ path: results[ri].path, data_base64: results[ri].data });
                    }
                }
            }

            bar.style.width = '60%';
            status.textContent = 'Sending content bundle to target...';

            // Step 4: Send the bundle to the target
            var bundle = {
                key: target.key,
                posts: gatherResp.posts,
                portfolio: gatherResp.portfolio,
                categories: gatherResp.categories,
                tags: gatherResp.tags,
                uploads: uploads,
                settings: []
            };

            var recvResp;
            try {
                var rr = await fetch(target.url.replace(/\/+$/, '') + '/api/deploy/receive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bundle),
                    signal: _deployAbort.signal
                });
                recvResp = await rr.json();
            } catch (e) {
                if (e.name === 'AbortError') return;
                throw new Error('Failed to send to target: ' + e.message);
            }

            if (!recvResp.ok) throw new Error('Receive failed: ' + (recvResp.error || 'Unknown error'));

            bar.style.width = '100%';
            _deployBusy = false;

            // Show done
            var st = recvResp.stats || {};
            var summary = '';
            if (st.posts_created) summary += st.posts_created + ' posts created, ';
            if (st.posts_updated) summary += st.posts_updated + ' posts updated, ';
            if (st.portfolio_created) summary += st.portfolio_created + ' portfolio created, ';
            if (st.portfolio_updated) summary += st.portfolio_updated + ' portfolio updated, ';
            if (st.uploads_written) summary += st.uploads_written + ' uploads transferred, ';
            if (st.categories_synced) summary += st.categories_synced + ' categories, ';
            if (st.tags_synced) summary += st.tags_synced + ' tags';
            summary = summary.replace(/, $/, '');
            document.getElementById('deploy-done-summary').textContent = summary || 'All content synced.';
            deployShowPhase('done');

        } catch (err) {
            _deployBusy = false;
            document.getElementById('deploy-error-text').textContent = err.message;
            deployShowPhase('error');
        }
    }
    {% endif %}
    </script>
</body>
</html>
