{% extends "admin/base" %}

{% block content %}
<div class="page-header"><h2><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings › AI</h2></div>

<div class="settings-nav">
    <a href="/{{ admin_slug }}/settings/general" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Site</a>
    <a href="/{{ admin_slug }}/settings/design" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><circle cx="13.5" cy="6.5" r="2.5"/><path d="M17.08 8.94a1.5 1.5 0 0 1 0 2.12l-7.07 7.07a1.5 1.5 0 0 1-2.12 0l-4.24-4.24a1.5 1.5 0 0 1 0-2.12l7.07-7.07a1.5 1.5 0 0 1 2.12 0z"/></svg>Frontend</a>
    <a href="/{{ admin_slug }}/settings/blog" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Journal</a>
    <a href="/{{ admin_slug }}/settings/portfolio" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Portfolio</a>
    <a href="/{{ admin_slug }}/settings/comments" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Comments</a>
    <a href="/{{ admin_slug }}/settings/typography" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>Typography</a>
    <a href="/{{ admin_slug }}/settings/images" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Media</a>
    <a href="/{{ admin_slug }}/settings/seo" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>SEO</a>
    <a href="/{{ admin_slug }}/settings/social" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M8 10h.01"/><path d="M12 10h.01"/><path d="M16 10h.01"/></svg>Social</a>
    <a href="/{{ admin_slug }}/settings/email" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email</a>
    <a href="/{{ admin_slug }}/settings/commerce" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>Commerce</a>
    <a href="/{{ admin_slug }}/settings/ai" class="tab active"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a2 2 0 0 1 0 4h-1v1a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-1H2a2 2 0 0 1 0-4h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="9" cy="15" r="1"/><circle cx="15" cy="15" r="1"/></svg>AI</a>
    <a href="/{{ admin_slug }}/settings/security" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Security</a>
    <a href="/{{ admin_slug }}/settings/users" class="tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Users</a>
</div>

<div class="sub-tabs">
    <button type="button" class="tab active" data-ai-tab="tab-ai-failover">Failover Chain</button>
    <button type="button" class="tab" data-ai-tab="tab-ai-ollama">Ollama{% if settings.ai_ollama_enabled == "true" %}<span class="status-dot"></span>{% endif %}</button>
    <button type="button" class="tab" data-ai-tab="tab-ai-openai">OpenAI{% if settings.ai_openai_enabled == "true" %}<span class="status-dot"></span>{% endif %}</button>
    <button type="button" class="tab" data-ai-tab="tab-ai-gemini">Gemini{% if settings.ai_gemini_enabled == "true" %}<span class="status-dot"></span>{% endif %}</button>
    <button type="button" class="tab" data-ai-tab="tab-ai-groq">Groq{% if settings.ai_groq_enabled == "true" %}<span class="status-dot"></span>{% endif %}</button>
    <button type="button" class="tab" data-ai-tab="tab-ai-cloudflare">Cloudflare{% if settings.ai_cloudflare_enabled == "true" %}<span class="status-dot"></span>{% endif %}</button>
</div>

<form method="post" action="/{{ admin_slug }}/settings/ai">

    <div id="tab-ai-failover">
        <div class="form-card">
            <h3>AI Failover Chain</h3>
            <p class="text-muted" style="margin-bottom:16px">Drag to reorder. If the primary provider fails, the next enabled provider in the chain will be used automatically.</p>
            <div id="failover-chain" class="failover-list">
                {% set chain = settings.ai_failover_chain | default(value='ollama,openai,gemini,groq,cloudflare') %}
                {% for provider in chain | split(pat=',') %}
                {% if provider == 'ollama' and settings.ai_ollama_enabled == 'true'
                    or provider == 'openai' and settings.ai_openai_enabled == 'true'
                    or provider == 'gemini' and settings.ai_gemini_enabled == 'true'
                    or provider == 'groq' and settings.ai_groq_enabled == 'true'
                    or provider == 'cloudflare' and settings.ai_cloudflare_enabled == 'true' %}
                <div class="failover-item" data-provider="{{ provider }}" draggable="true">
                    <span class="failover-handle">⠿</span>
                    <span class="failover-name">{% if provider == 'ollama' %}Ollama (Local){% elif provider == 'openai' %}OpenAI{% elif provider == 'gemini' %}Gemini{% elif provider == 'groq' %}Groq{% elif provider == 'cloudflare' %}Cloudflare Workers AI{% endif %}</span>
                    <span class="failover-badge"><span class="badge badge-published">Enabled</span></span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <p class="text-muted" style="font-size:13px;margin-top:8px">Only enabled providers appear here. Enable providers in their respective tabs.</p>
            <input type="hidden" id="ai_failover_chain" name="ai_failover_chain" value="{{ settings.ai_failover_chain | default(value='ollama,openai,gemini,groq,cloudflare') }}">
        </div>
    </div>

    <div id="tab-ai-ollama" style="display:none">
        <div class="form-card">
            <h3>Ollama (Local)</h3>
            <label class="checkbox-item"><input type="checkbox" name="ai_ollama_enabled" value="true" data-provider-toggle {% if settings.ai_ollama_enabled == "true" %}checked{% endif %}> Enable Ollama</label>
            <fieldset {% if settings.ai_ollama_enabled != "true" %}disabled{% endif %} style="border:none;padding:0;margin:0">
            <div class="form-group" style="margin-top:16px">
                <label for="ai_ollama_url">Server URL</label>
                <input type="text" id="ai_ollama_url" name="ai_ollama_url" value="{{ settings.ai_ollama_url | default(value='http://localhost:11434') }}" placeholder="http://localhost:11434">
            </div>
            <div class="form-group">
                <label for="ai_ollama_model">Model</label>
                <input type="text" id="ai_ollama_model" name="ai_ollama_model" value="{{ settings.ai_ollama_model | default(value='') }}" placeholder="e.g. llama3, mistral, codellama">
            </div>
            </fieldset>
        </div>
    </div>

    <div id="tab-ai-openai" style="display:none">
        <div class="form-card">
            <h3>OpenAI</h3>
            <label class="checkbox-item"><input type="checkbox" name="ai_openai_enabled" value="true" data-provider-toggle {% if settings.ai_openai_enabled == "true" %}checked{% endif %}> Enable OpenAI</label>
            <fieldset {% if settings.ai_openai_enabled != "true" %}disabled{% endif %} style="border:none;padding:0;margin:0">
            <div class="form-group" style="margin-top:16px">
                <label for="ai_openai_api_key">API Key</label>
                <input type="password" id="ai_openai_api_key" name="ai_openai_api_key" value="{{ settings.ai_openai_api_key | default(value='') }}" placeholder="sk-...">
            </div>
            <div class="form-group">
                <label for="ai_openai_model">Model</label>
                <input type="text" id="ai_openai_model" name="ai_openai_model" value="{{ settings.ai_openai_model | default(value='gpt-4') }}" placeholder="e.g. gpt-4, gpt-4o, gpt-3.5-turbo">
            </div>
            <div class="form-group">
                <label for="ai_openai_base_url">Base URL (optional)</label>
                <input type="text" id="ai_openai_base_url" name="ai_openai_base_url" value="{{ settings.ai_openai_base_url | default(value='') }}" placeholder="https://api.openai.com/v1">
                <span class="form-help">Override for OpenAI-compatible APIs (e.g. Azure, local proxies)</span>
            </div>
            </fieldset>
        </div>
    </div>

    <div id="tab-ai-gemini" style="display:none">
        <div class="form-card">
            <h3>Gemini</h3>
            <label class="checkbox-item"><input type="checkbox" name="ai_gemini_enabled" value="true" data-provider-toggle {% if settings.ai_gemini_enabled == "true" %}checked{% endif %}> Enable Gemini</label>
            <fieldset {% if settings.ai_gemini_enabled != "true" %}disabled{% endif %} style="border:none;padding:0;margin:0">
            <div class="form-group" style="margin-top:16px">
                <label for="ai_gemini_api_key">API Key</label>
                <input type="password" id="ai_gemini_api_key" name="ai_gemini_api_key" value="{{ settings.ai_gemini_api_key | default(value='') }}" placeholder="AIza...">
            </div>
            <div class="form-group">
                <label for="ai_gemini_model">Model</label>
                <input type="text" id="ai_gemini_model" name="ai_gemini_model" value="{{ settings.ai_gemini_model | default(value='gemini-pro') }}" placeholder="e.g. gemini-pro, gemini-1.5-pro">
            </div>
            </fieldset>
        </div>
    </div>

    <div id="tab-ai-groq" style="display:none">
        <div class="form-card">
            <h3>Groq</h3>
            <p class="text-muted" style="margin-bottom:12px">Blazing fast inference (~500 tokens/sec). Free tier available. Supports text and vision models.</p>
            <label class="checkbox-item"><input type="checkbox" name="ai_groq_enabled" value="true" data-provider-toggle {% if settings.ai_groq_enabled == "true" %}checked{% endif %}> Enable Groq</label>
            <fieldset {% if settings.ai_groq_enabled != "true" %}disabled{% endif %} style="border:none;padding:0;margin:0">
            <div class="form-group" style="margin-top:16px">
                <label for="ai_groq_api_key">API Key</label>
                <input type="password" id="ai_groq_api_key" name="ai_groq_api_key" value="{{ settings.ai_groq_api_key | default(value='') }}" placeholder="gsk_...">
                <span class="form-help">Get a free API key at <a href="https://console.groq.com/keys" target="_blank" style="color:var(--accent)">console.groq.com/keys</a></span>
            </div>
            <div class="form-group">
                <label for="ai_groq_model">Model</label>
                <select id="ai_groq_model" name="ai_groq_model">
                    <option value="llama-3.3-70b-versatile" {% if settings.ai_groq_model == "llama-3.3-70b-versatile" %}selected{% endif %}>Llama 3.3 70B Versatile — best quality</option>
                    <option value="llama-3.1-8b-instant" {% if settings.ai_groq_model == "llama-3.1-8b-instant" %}selected{% endif %}>Llama 3.1 8B Instant — fastest</option>
                    <option value="llama-3.2-11b-vision-preview" {% if settings.ai_groq_model == "llama-3.2-11b-vision-preview" %}selected{% endif %}>Llama 3.2 11B Vision — text + images</option>
                    <option value="mixtral-8x7b-32768" {% if settings.ai_groq_model == "mixtral-8x7b-32768" %}selected{% endif %}>Mixtral 8x7B — 32K context</option>
                    <option value="gemma2-9b-it" {% if settings.ai_groq_model == "gemma2-9b-it" %}selected{% endif %}>Gemma 2 9B — Google's model</option>
                </select>
            </div>
            </fieldset>
        </div>
    </div>

    <div id="tab-ai-cloudflare" style="display:none">
        <div class="form-card">
            <h3>Cloudflare Workers AI</h3>
            <label class="checkbox-item"><input type="checkbox" name="ai_cloudflare_enabled" value="true" data-provider-toggle {% if settings.ai_cloudflare_enabled == "true" %}checked{% endif %}> Enable Cloudflare Workers AI</label>
            <fieldset {% if settings.ai_cloudflare_enabled != "true" %}disabled{% endif %} style="border:none;padding:0;margin:0">
            <div class="form-group" style="margin-top:16px">
                <label for="ai_cloudflare_account_id">Account ID</label>
                <input type="text" id="ai_cloudflare_account_id" name="ai_cloudflare_account_id" value="{{ settings.ai_cloudflare_account_id | default(value='') }}" placeholder="Your Cloudflare account ID">
            </div>
            <div class="form-group">
                <label for="ai_cloudflare_api_token">API Token</label>
                <input type="password" id="ai_cloudflare_api_token" name="ai_cloudflare_api_token" value="{{ settings.ai_cloudflare_api_token | default(value='') }}" placeholder="Bearer token">
            </div>
            <div class="form-group">
                <label for="ai_cloudflare_model">Model</label>
                <input type="text" id="ai_cloudflare_model" name="ai_cloudflare_model" value="{{ settings.ai_cloudflare_model | default(value='@cf/meta/llama-3-8b-instruct') }}" placeholder="e.g. @cf/meta/llama-3-8b-instruct">
            </div>
            </fieldset>
        </div>
    </div>

    <div class="form-actions"><button type="submit" class="btn btn-primary">Save <span class="kbd"><span class="kbd-mod">⌘</span>S</span></button></div>
</form>
{% endblock content %}

{% block scripts %}
<script>
(function() {
    // Sub-tab switching
    var tabs = document.querySelectorAll('[data-ai-tab]');
    var panels = ['tab-ai-failover','tab-ai-ollama','tab-ai-openai','tab-ai-gemini','tab-ai-groq','tab-ai-cloudflare'];
    function activateTab(name) {
        tabs.forEach(function(t) { t.classList.remove('active'); });
        panels.forEach(function(id) { document.getElementById(id).style.display = 'none'; });
        tabs.forEach(function(t) { if (t.dataset.aiTab === name) t.classList.add('active'); });
        var el = document.getElementById(name);
        if (el) el.style.display = '';
    }
    tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
            activateTab(tab.dataset.aiTab);
            location.hash = tab.dataset.aiTab;
        });
    });
    if (location.hash) { activateTab(location.hash.substring(1)); }

    // Failover chain drag-and-drop reorder
    var chain = document.getElementById('failover-chain');
    var hiddenChain = document.getElementById('ai_failover_chain');
    var dragItem = null;

    chain.addEventListener('dragstart', function(e) {
        dragItem = e.target.closest('.failover-item');
        if (dragItem) {
            dragItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
    });
    chain.addEventListener('dragend', function() {
        if (dragItem) dragItem.classList.remove('dragging');
        dragItem = null;
        updateChainOrder();
    });
    chain.addEventListener('dragover', function(e) {
        e.preventDefault();
        var target = e.target.closest('.failover-item');
        if (target && target !== dragItem) {
            var rect = target.getBoundingClientRect();
            var mid = rect.top + rect.height / 2;
            if (e.clientY < mid) {
                chain.insertBefore(dragItem, target);
            } else {
                chain.insertBefore(dragItem, target.nextSibling);
            }
        }
    });

    function updateChainOrder() {
        var items = chain.querySelectorAll('.failover-item');
        var order = [];
        items.forEach(function(item) { order.push(item.dataset.provider); });
        hiddenChain.value = order.join(',');
    }
    // Provider toggle: enable/disable fieldset when checkbox changes
    document.querySelectorAll('[data-provider-toggle]').forEach(function(cb) {
        cb.addEventListener('change', function() {
            var fs = this.closest('.form-card').querySelector('fieldset');
            if (fs) fs.disabled = !this.checked;
        });
    });
})();
</script>
{% endblock scripts %}
