<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup — Velocty</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
</head>
<body class="login-page">
    <div class="setup-card">
        <div class="setup-logo">
            <img src="/static/images/logo-transparent.png" alt="Velocty" style="height:36px;width:auto;margin-bottom:4px">
            <p class="text-muted" style="font-size:13px;margin:0">Welcome! Let's get your site set up.</p>
        </div>

        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}

        <form method="post" action="/{{ admin_slug }}/setup" id="setup-form">
            <!-- Step 1: Database -->
            <div class="setup-step" id="step-1">
                <h3>1. Database</h3>
                <p class="text-muted" style="font-size:13px;margin-bottom:16px">Choose where your site data will be stored. This cannot be changed later.</p>

                <label class="db-choice {% if db_backend | default(value='sqlite') == 'sqlite' %}selected{% endif %}" id="choice-sqlite" onclick="selectDb('sqlite')">
                    <input type="radio" name="db_backend" value="sqlite" {% if db_backend | default(value='sqlite') == "sqlite" %}checked{% endif %} style="display:none">
                    <div class="db-choice-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                        <div>
                            <strong>SQLite</strong><span class="badge" style="margin-left:8px;font-size:10px;padding:2px 6px;background:var(--accent);color:#fff;border-radius:4px">Recommended</span>
                            <div class="text-muted" style="font-size:12px;margin-top:2px">Embedded, zero-config, single-file database</div>
                        </div>
                    </div>
                    <div class="db-pros-cons">
                        <div class="db-pros">
                            <div class="db-label">Pros</div>
                            <ul>
                                <li>Zero setup — works out of the box</li>
                                <li>Fast reads, sub-millisecond queries</li>
                                <li>Easy backup — just copy one file</li>
                                <li>Low resource usage, no background daemon</li>
                                <li>Portable — move the file anywhere</li>
                            </ul>
                        </div>
                        <div class="db-cons">
                            <div class="db-label">Cons</div>
                            <ul>
                                <li>Single file = single point of failure</li>
                                <li>Deleting the file loses all data</li>
                                <li>No built-in replication</li>
                                <li>Limited write concurrency</li>
                            </ul>
                        </div>
                    </div>
                </label>

                <label class="db-choice {% if db_backend | default(value='sqlite') == 'mongodb' %}selected{% endif %}" id="choice-mongodb" onclick="selectDb('mongodb')" style="margin-top:12px">
                    <input type="radio" name="db_backend" value="mongodb" {% if db_backend | default(value='sqlite') == "mongodb" %}checked{% endif %} style="display:none">
                    <div class="db-choice-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M12 6v12"/><path d="M8 8c0 2.21 1.79 4 4 4s4-1.79 4-4"/><path d="M8 16c0-2.21 1.79-4 4-4s4 1.79 4 4"/></svg>
                        <div>
                            <strong>MongoDB</strong>
                            <div class="text-muted" style="font-size:12px;margin-top:2px">Scalable document database, ideal for production & multi-site</div>
                        </div>
                    </div>
                    <div class="db-pros-cons">
                        <div class="db-pros">
                            <div class="db-label">Pros</div>
                            <ul>
                                <li>Replica sets — automatic failover</li>
                                <li>Handles high concurrent writes</li>
                                <li>Natural multi-site fit (one DB per site)</li>
                                <li>Cloud-ready (MongoDB Atlas)</li>
                                <li>Built-in backup & restore tools</li>
                            </ul>
                        </div>
                        <div class="db-cons">
                            <div class="db-label">Cons</div>
                            <ul>
                                <li>Requires a running MongoDB server</li>
                                <li>Higher memory usage</li>
                                <li>More complex setup & maintenance</li>
                                <li>Overkill for small personal sites</li>
                            </ul>
                        </div>
                    </div>
                    <div id="mongo-fields" style="{% if db_backend | default(value='sqlite') != 'mongodb' %}display:none;{% endif %}margin-top:12px">
                        <div class="form-group">
                            <label for="mongo_uri">Connection URI</label>
                            <input type="text" id="mongo_uri" name="mongo_uri" value="{{ mongo_uri | default(value='mongodb://localhost:27017') }}" placeholder="mongodb://localhost:27017">
                            <span class="form-help">MongoDB connection string. Supports Atlas URIs.</span>
                        </div>
                        <div class="form-group">
                            <label for="mongo_db_name">Database Name</label>
                            <input type="text" id="mongo_db_name" name="mongo_db_name" value="{{ mongo_db_name | default(value='velocty') }}" placeholder="velocty">
                        </div>
                        <label class="checkbox-item" style="margin-top:12px">
                            <input type="checkbox" id="mongo_auth_enabled" name="mongo_auth_enabled" value="true" {% if mongo_auth_enabled == "true" %}checked{% endif %} onchange="toggleMongoAuth()"> Requires authentication
                        </label>
                        <div id="mongo-auth-fields" style="{% if mongo_auth_enabled != 'true' %}display:none;{% endif %}margin-top:12px">
                            <div class="form-group">
                                <label for="mongo_auth_mechanism">Auth Mechanism</label>
                                <select id="mongo_auth_mechanism" name="mongo_auth_mechanism">
                                    <option value="scram_sha256" {% if mongo_auth_mechanism | default(value='scram_sha256') == "scram_sha256" %}selected{% endif %}>SCRAM-SHA-256 (default)</option>
                                    <option value="scram_sha1" {% if mongo_auth_mechanism == "scram_sha1" %}selected{% endif %}>SCRAM-SHA-1</option>
                                    <option value="x509" {% if mongo_auth_mechanism == "x509" %}selected{% endif %}>X.509 Certificate</option>
                                    <option value="ldap" {% if mongo_auth_mechanism == "ldap" %}selected{% endif %}>LDAP (PLAIN)</option>
                                    <option value="aws" {% if mongo_auth_mechanism == "aws" %}selected{% endif %}>AWS IAM</option>
                                </select>
                            </div>
                            <div id="mongo-cred-fields" style="{% if mongo_auth_mechanism == 'x509' or mongo_auth_mechanism == 'aws' %}display:none;{% endif %}">
                                <div class="form-group">
                                    <label for="mongo_username">Username</label>
                                    <input type="text" id="mongo_username" name="mongo_username" value="{{ mongo_username | default(value='') }}" placeholder="admin">
                                </div>
                                <div class="form-group">
                                    <label for="mongo_password">Password</label>
                                    <input type="password" id="mongo_password" name="mongo_password" value="{{ mongo_password | default(value='') }}" placeholder="••••••••">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mongo_auth_db">Auth Database</label>
                                <input type="text" id="mongo_auth_db" name="mongo_auth_db" value="{{ mongo_auth_db | default(value='admin') }}" placeholder="admin">
                                <span class="form-help">Database used for authentication (usually "admin").</span>
                            </div>
                        </div>
                        <div style="margin-top:16px;display:flex;align-items:center;gap:10px">
                            <button type="button" class="btn btn-secondary" id="test-mongo-btn" onclick="testMongoConnection()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Test Connection
                            </button>
                            <span id="test-mongo-status" style="font-size:13px"></span>
                        </div>
                    </div>
                </label>

                <div class="form-actions" style="justify-content:flex-end;margin-top:20px">
                    <button type="button" class="btn btn-primary" onclick="goStep(2)">Next →</button>
                </div>
            </div>

            <!-- Step 2: Site -->
            <div class="setup-step" id="step-2" style="display:none">
                <h3>2. Your Site</h3>
                <div class="form-group">
                    <label for="site_name">Site Name</label>
                    <input type="text" id="site_name" name="site_name" value="{{ site_name }}" placeholder="My Awesome Site" required>
                </div>
                <div class="form-group">
                    <label for="site_environment">Environment</label>
                    <select id="site_environment" name="site_environment">
                        <option value="staging" {% if site_environment == "staging" %}selected{% endif %}>Dev / Staging</option>
                        <option value="production" {% if site_environment == "production" %}selected{% endif %}>Production</option>
                    </select>
                    <span class="form-help">Choose <strong>Production</strong> for your live public site, or <strong>Dev / Staging</strong> for local development and testing. This controls deploy functionality and can be changed later in Settings.</span>
                </div>
                <div class="form-actions" style="justify-content:space-between">
                    <button type="button" class="btn btn-secondary" onclick="goStep(1)">← Back</button>
                    <button type="button" class="btn btn-primary" onclick="goStep(3)">Next →</button>
                </div>
            </div>

            <!-- Step 3: Admin Account -->
            <div class="setup-step" id="step-3" style="display:none">
                <h3>3. Admin Account</h3>
                <div class="form-group">
                    <label for="admin_email">Email</label>
                    <input type="email" id="admin_email" name="admin_email" value="{{ admin_email }}" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Minimum 8 characters" required minlength="8">
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" placeholder="Re-enter password" required>
                </div>
                <div class="form-actions" style="justify-content:space-between">
                    <button type="button" class="btn btn-secondary" onclick="goStep(2)">← Back</button>
                    <button type="button" class="btn btn-primary" onclick="goStep(4)">Next →</button>
                </div>
            </div>

            <!-- Step 4: Terms -->
            <div class="setup-step" id="step-4" style="display:none">
                <h3>4. Terms & Privacy</h3>
                <div class="terms-box">
                    <h4>Terms of Use</h4>
                    <p>By using Velocty, you agree to use this software responsibly. Velocty is provided "as is" without warranty of any kind. You are responsible for the content you publish and for maintaining the security of your admin credentials.</p>
                    <h4 style="margin-top:16px">Privacy Policy</h4>
                    <p>Velocty stores all data locally on your server. No data is sent to external services unless you explicitly configure third-party integrations (e.g. AI providers, PayPal, Google Fonts). Analytics data is collected locally and never shared.</p>
                </div>
                <label class="checkbox-item" style="margin-top:16px">
                    <input type="checkbox" name="accept_terms" value="true" id="accept_terms">
                    I accept the Terms of Use and Privacy Policy
                </label>
                <div class="form-actions" style="justify-content:space-between;margin-top:20px">
                    <button type="button" class="btn btn-secondary" onclick="goStep(3)">← Back</button>
                    <button type="submit" class="btn btn-primary" id="finish-btn" disabled>Finish Setup</button>
                </div>
            </div>
        </form>

        <div class="setup-progress">
            <div class="progress-dot active" id="dot-1"></div>
            <div class="progress-dot" id="dot-2"></div>
            <div class="progress-dot" id="dot-3"></div>
            <div class="progress-dot" id="dot-4"></div>
        </div>
    </div>

<script>
var currentStep = 1;
var totalSteps = 4;

function selectDb(backend) {
    document.getElementById('choice-sqlite').classList.toggle('selected', backend === 'sqlite');
    document.getElementById('choice-mongodb').classList.toggle('selected', backend === 'mongodb');
    document.getElementById('mongo-fields').style.display = backend === 'mongodb' ? '' : 'none';
    var radios = document.querySelectorAll('input[name="db_backend"]');
    for (var i = 0; i < radios.length; i++) {
        radios[i].checked = radios[i].value === backend;
    }
}

function toggleMongoAuth() {
    var cb = document.getElementById('mongo_auth_enabled');
    document.getElementById('mongo-auth-fields').style.display = cb.checked ? '' : 'none';
}

function testMongoConnection() {
    var btn = document.getElementById('test-mongo-btn');
    var status = document.getElementById('test-mongo-status');
    var uri = document.getElementById('mongo_uri').value.trim();
    if (!uri) {
        status.style.color = '#ef4444';
        status.textContent = 'Please enter a Connection URI first.';
        document.getElementById('mongo_uri').focus();
        return;
    }
    btn.disabled = true;
    btn.textContent = 'Testing...';
    status.style.color = 'var(--text-secondary)';
    status.textContent = 'Connecting...';
    fetch('/{{ admin_slug }}/setup/test-mongo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uri: uri })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        status.style.color = data.ok ? '#22c55e' : '#ef4444';
        status.textContent = data.message;
    })
    .catch(function(err) {
        status.style.color = '#ef4444';
        status.textContent = 'Request failed: ' + err.message;
    })
    .finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Test Connection';
    });
}

// Show/hide username+password based on auth mechanism (X.509 and AWS don't need them)
(function() {
    var sel = document.getElementById('mongo_auth_mechanism');
    if (sel) {
        sel.addEventListener('change', function() {
            var creds = document.getElementById('mongo-cred-fields');
            var noCreds = this.value === 'x509' || this.value === 'aws';
            creds.style.display = noCreds ? 'none' : '';
        });
    }
})();

function goStep(n) {
    if (n > currentStep) {
        // Step 1: DB choice — validate MongoDB fields if selected
        if (currentStep === 1) {
            var sel = document.querySelector('input[name="db_backend"]:checked');
            if (!sel) return;
            if (sel.value === 'mongodb') {
                var uri = document.getElementById('mongo_uri');
                var dbName = document.getElementById('mongo_db_name');
                if (!uri.value.trim()) { uri.focus(); return; }
                if (!dbName.value.trim()) { dbName.focus(); return; }
                // Validate auth fields if auth is enabled
                var authCb = document.getElementById('mongo_auth_enabled');
                if (authCb && authCb.checked) {
                    var mech = document.getElementById('mongo_auth_mechanism').value;
                    if (mech !== 'x509' && mech !== 'aws') {
                        var user = document.getElementById('mongo_username');
                        var pass = document.getElementById('mongo_password');
                        if (!user.value.trim()) { user.focus(); return; }
                        if (!pass.value.trim()) { pass.focus(); return; }
                    }
                }
            }
        }
        // Step 2: Site name
        if (currentStep === 2) {
            var name = document.getElementById('site_name');
            if (!name.value.trim()) { name.focus(); return; }
        }
        // Step 3: Admin account
        if (currentStep === 3) {
            var email = document.getElementById('admin_email');
            var pw = document.getElementById('password');
            var cpw = document.getElementById('confirm_password');
            if (!email.value.trim()) { email.focus(); return; }
            if (pw.value.length < 8) { pw.focus(); pw.setCustomValidity('Minimum 8 characters'); pw.reportValidity(); return; }
            pw.setCustomValidity('');
            if (pw.value !== cpw.value) { cpw.setCustomValidity('Passwords do not match'); cpw.reportValidity(); return; }
            cpw.setCustomValidity('');
        }
    }
    document.getElementById('step-' + currentStep).style.display = 'none';
    document.getElementById('step-' + n).style.display = '';
    for (var i = 1; i <= totalSteps; i++) {
        var dot = document.getElementById('dot-' + i);
        dot.classList.toggle('active', i <= n);
    }
    currentStep = n;
    var firstInput = document.querySelector('#step-' + n + ' input:not([type="radio"]):not([type="hidden"])');
    if (firstInput) firstInput.focus();
}

document.getElementById('accept_terms').addEventListener('change', function() {
    document.getElementById('finish-btn').disabled = !this.checked;
});
</script>
</body>
</html>
