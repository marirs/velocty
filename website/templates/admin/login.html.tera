<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login — Velocty Admin</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    {% if captcha_provider is defined and captcha_provider == "recaptcha" %}
        {% if captcha_version is defined and captcha_version == "v3" %}
    <script src="https://www.google.com/recaptcha/api.js?render={{ captcha_site_key }}"></script>
        {% else %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
        {% endif %}
    {% elif captcha_provider is defined and captcha_provider == "turnstile" %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% elif captcha_provider is defined and captcha_provider == "hcaptcha" %}
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    {% endif %}
</head>
<body class="login-page" data-theme="{{ admin_theme | default(value='dark') }}">
    <div class="login-card">
        <div class="login-logo">
            {% if admin_theme | default(value='dark') == "light" %}
            <img src="/static/images/logo-transparent-light.png" alt="Velocty" style="height:32px;width:auto;margin-bottom:8px">
            {% else %}
            <img src="/static/images/logo-transparent.png" alt="Velocty" style="height:32px;width:auto;margin-bottom:8px">
            {% endif %}
        </div>
        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}
        {% if reset_success %}
        <div class="alert alert-success" style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:var(--success, #22c55e);padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px">Password reset successfully. Please log in with your new password.</div>
        {% endif %}
        <!-- Password login view -->
        <div id="password-login-view">
            <form id="login-form" method="post" action="/{{ admin_slug }}/login">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required autofocus>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                {% if captcha_provider is defined and captcha_provider == "recaptcha" and captcha_version is defined and captcha_version != "v3" %}
                <div class="form-group">
                    <div class="g-recaptcha" data-sitekey="{{ captcha_site_key }}"></div>
                </div>
                {% elif captcha_provider is defined and captcha_provider == "turnstile" %}
                <div class="form-group">
                    <div class="cf-turnstile" data-sitekey="{{ captcha_site_key }}"></div>
                </div>
                {% elif captcha_provider is defined and captcha_provider == "hcaptcha" %}
                <div class="form-group">
                    <div class="h-captcha" data-sitekey="{{ captcha_site_key }}"></div>
                </div>
                {% endif %}
                <input type="hidden" name="captcha_token" id="captcha_token" value="">
                <button type="submit" class="btn btn-primary btn-full">Log In</button>
            </form>
            <div style="text-align:center;margin-top:12px">
                <a href="/{{ admin_slug }}/forgot-password" style="color:var(--text-secondary);font-size:13px;text-decoration:none">Forgot Password?</a>
            </div>
            <div style="display:flex;align-items:center;gap:12px;margin:18px 0 14px">
                <div style="flex:1;height:1px;background:var(--border-subtle)"></div>
                <span style="color:var(--text-tertiary);font-size:12px;text-transform:uppercase;letter-spacing:1px">or</span>
                <div style="flex:1;height:1px;background:var(--border-subtle)"></div>
            </div>
            <button type="button" class="btn btn-full" id="passkey-show-btn" onclick="showPasskeyLogin()" style="display:flex;align-items:center;justify-content:center;gap:8px;background:transparent;border:1px solid var(--border-input);color:var(--text-primary)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Sign in with Passkey
            </button>
        </div>

        <!-- Passkey login view (hidden by default) -->
        <div id="passkey-login-view" style="display:none">
            <div class="form-group">
                <label for="passkey-email">Email</label>
                <input type="email" id="passkey-email" required>
            </div>
            <button type="button" class="btn btn-primary btn-full" id="passkey-login-btn" onclick="passkeyLogin()" style="display:flex;align-items:center;justify-content:center;gap:8px">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Sign in with Passkey
            </button>
            <p id="passkey-login-error" style="color:var(--danger);font-size:12px;margin-top:8px;display:none;text-align:center"></p>
            <div style="text-align:center;margin-top:14px">
                <a href="#" onclick="showPasswordLogin();return false" style="color:var(--text-secondary);font-size:13px;text-decoration:none">Try another way</a>
            </div>
        </div>
    </div>
    {% if captcha_provider is defined and captcha_provider != "" %}
    <script>
    (function(){
        var form = document.getElementById('login-form');
        if (!form) return;
        var provider = '{{ captcha_provider | default(value="") }}';
        var siteKey = '{{ captcha_site_key | default(value="") }}';
        var version = '{{ captcha_version | default(value="") }}';

        form.addEventListener('submit', function(e) {
            var tokenField = document.getElementById('captcha_token');
            if (tokenField.value) return; // already have token

            if (provider === 'recaptcha' && version === 'v3') {
                e.preventDefault();
                grecaptcha.execute(siteKey, {action: 'login'}).then(function(token) {
                    tokenField.value = token;
                    form.submit();
                });
            } else if (provider === 'recaptcha') {
                tokenField.value = grecaptcha.getResponse();
            } else if (provider === 'turnstile') {
                var resp = document.querySelector('[name="cf-turnstile-response"]');
                if (resp) tokenField.value = resp.value;
            } else if (provider === 'hcaptcha') {
                tokenField.value = hcaptcha.getResponse();
            }
        });
    })();
    </script>
    {% endif %}
    <script>
    var adminSlug = '{{ admin_slug | default(value="admin") }}';

    function base64urlToBuffer(b64) {
        var str = b64.replace(/-/g, '+').replace(/_/g, '/');
        while (str.length % 4) str += '=';
        var bin = atob(str);
        var buf = new Uint8Array(bin.length);
        for (var i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
        return buf.buffer;
    }
    function bufferToBase64url(buf) {
        var bytes = new Uint8Array(buf);
        var str = '';
        for (var i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function showPasskeyLogin() {
        document.getElementById('password-login-view').style.display = 'none';
        document.getElementById('passkey-login-view').style.display = '';
        var pe = document.getElementById('passkey-email');
        var em = document.getElementById('email');
        if (em && em.value) pe.value = em.value;
        pe.focus();
    }
    function showPasswordLogin() {
        document.getElementById('passkey-login-view').style.display = 'none';
        document.getElementById('password-login-view').style.display = '';
        var em = document.getElementById('email');
        var pe = document.getElementById('passkey-email');
        if (pe && pe.value) em.value = pe.value;
        em.focus();
    }

    function passkeyLogin() {
        var errEl = document.getElementById('passkey-login-error');
        errEl.style.display = 'none';
        var email = document.getElementById('passkey-email').value.trim();
        if (!email) {
            errEl.textContent = 'Please enter your email address.';
            errEl.style.display = '';
            return;
        }

        var btn = document.getElementById('passkey-login-btn');
        btn.disabled = true;
        btn.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite"></span> Verifying…';

        var authToken = '';

        fetch('/' + adminSlug + '/passkey/auth/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (!d.ok) throw new Error(d.error || 'Authentication failed');
            authToken = d.token;
            var opts = d.options;
            opts.publicKey.challenge = base64urlToBuffer(opts.publicKey.challenge);
            if (opts.publicKey.allowCredentials) {
                opts.publicKey.allowCredentials.forEach(function(c) {
                    c.id = base64urlToBuffer(c.id);
                });
            }
            return navigator.credentials.get(opts);
        })
        .then(function(assertion) {
            if (!assertion) throw new Error('Authentication cancelled');
            var cred = {
                id: assertion.id,
                rawId: bufferToBase64url(assertion.rawId),
                type: assertion.type,
                response: {
                    authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
                    clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
                    signature: bufferToBase64url(assertion.response.signature)
                }
            };
            if (assertion.response.userHandle) {
                cred.response.userHandle = bufferToBase64url(assertion.response.userHandle);
            }
            return fetch('/' + adminSlug + '/passkey/auth/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: authToken, credential: cred })
            });
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (!d.ok) throw new Error(d.error || 'Verification failed');
            window.location.href = d.redirect;
        })
        .catch(function(e) {
            btn.disabled = false;
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Sign in with Passkey';
            errEl.textContent = e.message || 'Passkey authentication failed';
            errEl.style.display = '';
        });
    }

    // Enter key on passkey email triggers login
    document.addEventListener('DOMContentLoaded', function() {
        var pe = document.getElementById('passkey-email');
        if (pe) {
            pe.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); passkeyLogin(); }
            });
        }
    });
    </script>
    <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</body>
</html>
