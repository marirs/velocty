<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Link — Velocty Admin</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    {% if captcha_provider is defined and captcha_provider == "recaptcha" %}
        {% if captcha_version is defined and captcha_version == "v3" %}
    <script src="https://www.google.com/recaptcha/api.js?render={{ captcha_site_key }}"></script>
        {% else %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
        {% endif %}
    {% elif captcha_provider is defined and captcha_provider == "turnstile" %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% elif captcha_provider is defined and captcha_provider == "hcaptcha" %}
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    {% endif %}
</head>
<body class="login-page" data-theme="{{ admin_theme | default(value='dark') }}">
    <div class="login-card">
        <div class="login-logo">
            {% if admin_theme | default(value='dark') == "light" %}
            <img src="/static/images/logo-transparent-light.png" alt="Velocty" style="height:32px;width:auto;margin-bottom:8px">
            {% else %}
            <img src="/static/images/logo-transparent.png" alt="Velocty" style="height:32px;width:auto;margin-bottom:8px">
            {% endif %}
        </div>
        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}
        {% if success %}
        <div class="alert alert-success" style="background:var(--success,#22c55e);color:#fff;padding:12px 16px;border-radius:6px;margin-bottom:16px;font-size:14px">{{ success }}</div>
        {% else %}
        <p style="text-align:center;font-size:14px;color:var(--text-secondary,#888);margin-bottom:20px">Enter your email and we'll send you a one-time login link.</p>
        <form id="magic-link-form" method="post" action="/{{ admin_slug }}/magic-link">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required autofocus>
            </div>
            {% if captcha_provider is defined and captcha_provider == "recaptcha" and captcha_version is defined and captcha_version != "v3" %}
            <div class="form-group">
                <div class="g-recaptcha" data-sitekey="{{ captcha_site_key }}"></div>
            </div>
            {% elif captcha_provider is defined and captcha_provider == "turnstile" %}
            <div class="form-group">
                <div class="cf-turnstile" data-sitekey="{{ captcha_site_key }}"></div>
            </div>
            {% elif captcha_provider is defined and captcha_provider == "hcaptcha" %}
            <div class="form-group">
                <div class="h-captcha" data-sitekey="{{ captcha_site_key }}"></div>
            </div>
            {% endif %}
            <input type="hidden" name="captcha_token" id="captcha_token" value="">
            <button type="submit" class="btn btn-primary btn-full">Send Magic Link</button>
        </form>
        {% endif %}
        <div style="text-align:center;margin-top:16px">
            <a href="/{{ admin_slug }}/login" style="font-size:13px;color:var(--text-secondary,#888)">← Back to password login</a>
        </div>
    </div>
    {% if captcha_provider is defined and captcha_provider != "" %}
    <script>
    (function(){
        var form = document.getElementById('magic-link-form');
        if (!form) return;
        var provider = '{{ captcha_provider | default(value="") }}';
        var siteKey = '{{ captcha_site_key | default(value="") }}';
        var version = '{{ captcha_version | default(value="") }}';

        form.addEventListener('submit', function(e) {
            var tokenField = document.getElementById('captcha_token');
            if (tokenField.value) return;

            if (provider === 'recaptcha' && version === 'v3') {
                e.preventDefault();
                grecaptcha.execute(siteKey, {action: 'magic_link'}).then(function(token) {
                    tokenField.value = token;
                    form.submit();
                });
            } else if (provider === 'recaptcha') {
                tokenField.value = grecaptcha.getResponse();
            } else if (provider === 'turnstile') {
                var resp = document.querySelector('[name="cf-turnstile-response"]');
                if (resp) tokenField.value = resp.value;
            } else if (provider === 'hcaptcha') {
                tokenField.value = hcaptcha.getResponse();
            }
        });
    })();
    </script>
    {% endif %}
</body>
</html>
