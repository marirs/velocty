{% extends "admin/base" %}

{% block head_extra %}
<link rel="stylesheet" href="/static/js/flatpickr/flatpickr.min.css">
<link rel="stylesheet" href="/static/js/flatpickr/flatpickr-dark.css">
{% endblock head_extra %}

{% block content %}
<div class="page-header">
    <h2><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>{% if post %}Edit Post{% else %}New Post{% endif %}</h2>
    <div class="header-actions">
        <button type="submit" form="post-form" name="status" value="draft" class="btn btn-secondary">Save Draft</button>
        <button type="submit" form="post-form" name="status" value="published" class="btn btn-primary" id="btn-publish">Publish <span class="kbd"><span class="kbd-mod">⌘</span>S</span></button>
    </div>
</div>

<form id="post-form" method="post" action="{% if post %}/{{ admin_slug }}/posts/{{ post.id }}/edit{% else %}/{{ admin_slug }}/posts/new{% endif %}" enctype="multipart/form-data">
    <div class="editor-layout">
        <div class="editor-main">
            {% if ai_enabled and not post %}
            <div class="form-card" id="ai-generate-section">
                <h4>✨ Generate with AI</h4>
                <p class="text-muted" style="font-size:13px;margin-bottom:8px">Describe what you want to write about and AI will generate a full post.</p>
                <div class="ai-generate-bar">
                    <input type="text" id="ai-generate-input" placeholder="e.g. A beginner's guide to landscape photography with tips on composition and lighting" style="flex:1">
                    <button type="button" id="ai-generate-btn" class="btn btn-primary btn-sm" onclick="aiGeneratePost()">✨ Generate</button>
                </div>
            </div>
            {% endif %}

            <div class="form-card">
                <div class="form-group">
                    <label for="title">Title {% if ai_enabled %}<button type="button" class="btn-ai-suggest" onclick="aiSuggestTitleOpen()" title="AI Suggest Title">✨ Suggest</button>{% endif %}</label>
                    <input type="text" id="title" name="title" value="{% if post %}{{ post.title }}{% endif %}" required class="input-lg">
                </div>
                <div class="form-group">
                    <label for="slug">Slug</label>
                    <input type="text" id="slug" name="slug" value="{% if post %}{{ post.slug }}{% endif %}" required>
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" name="content_html" rows="20" class="editor-textarea">{% if post %}{{ post.content_html | safe }}{% endif %}</textarea>
                </div>
                <div class="form-group">
                    <label for="excerpt">Excerpt</label>
                    <textarea id="excerpt" name="excerpt" rows="3">{% if post %}{{ post.excerpt | default(value="") }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <div class="editor-sidebar">
            <div class="form-card collapsible">
                <h4>Featured Image</h4>
                <div class="form-group">
                    <input type="hidden" id="featured-uploaded-path" name="uploaded_featured_path" value="">
                    <div class="image-drop-zone {% if post and post.featured_image %}has-image{% endif %}" id="featured-zone" style="width:100%;height:120px">
                        <input type="file" id="featured-file" name="featured_image" accept="image/*,.heic,.heif">
                        <div class="drop-placeholder" id="featured-placeholder" {% if post and post.featured_image %}style="display:none"{% endif %}>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 16v-8m-4 4l4-4 4 4"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg>
                            <span>Drop image here or click to upload</span>
                        </div>
                        {% if post and post.featured_image %}
                        <img id="featured-preview" src="/uploads/{{ post.featured_image }}" alt="Featured">
                        {% else %}
                        <img id="featured-preview" style="display:none" alt="Featured">
                        {% endif %}
                        <button type="button" class="drop-clear" id="featured-clear" title="Remove">&times;</button>
                    </div>
                    <a href="javascript:void(0)" class="ml-browse-link" id="featured-browse-ml">Browse Media Library</a>
                    {% if ai_enabled %}
                    <button type="button" class="btn btn-sm btn-primary" id="btn-suggest-all" onclick="aiSuggestAll()" style="width:100%;margin-top:8px">✨ Suggest All</button>
                    {% endif %}
                </div>
            </div>

            <div class="form-card collapsible">
                <h4>Publish Date</h4>
                <div class="form-group" style="margin-bottom:0">
                    <input type="text" name="published_at" id="published_at" value="{% if post and post.published_at %}{{ post.published_at | date(format='%Y-%m-%dT%H:%M') }}{% endif %}" style="font-size:12px" placeholder="Select date & time..." autocomplete="off">
                    <p class="text-muted" style="font-size:11px;margin-top:4px">Leave empty to use current time on publish. Set a future date to schedule.</p>
                </div>
            </div>

            <div class="form-card collapsible">
                <h4>Categories {% if ai_enabled %}<button type="button" class="btn-ai-suggest" onclick="aiSuggestCategory()" title="AI Suggest Category">✨ Suggest</button>{% endif %}</h4>
                <div class="checkbox-list" id="category-list">
                    {% for cat in categories %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="category_ids" value="{{ cat.id }}"
                            {% if post_categories is defined and cat.id in post_categories %}checked{% endif %}>
                        {{ cat.name }}
                    </label>
                    {% endfor %}
                </div>
                <div style="margin-top:8px;display:flex;gap:6px" id="add-cat-row">
                    <input type="text" id="new-cat-name" placeholder="New category…" style="flex:1;font-size:12px;padding:5px 8px">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addCategory()" style="white-space:nowrap;font-size:11px;padding:4px 10px">+ Add</button>
                </div>
            </div>

            <div class="form-card collapsible">
                <h4>Tags {% if ai_enabled %}<button type="button" class="btn-ai-suggest" onclick="aiSuggestTags()" title="AI Suggest Tags">✨ Suggest</button>{% endif %}</h4>
                <div class="form-group">
                    <input type="text" placeholder="Type to add tags..." class="tag-input" id="tag-input-field">
                    <input type="hidden" name="tag_names" id="tag-names-hidden">
                    <div class="tag-list" id="tag-list">
                        {% if post_tags is defined %}
                        {% for tag in tags %}
                        {% if tag.id in post_tags %}
                        <span class="tag-pill" data-tag-name="{{ tag.name }}">{{ tag.name }} <button type="button" class="tag-remove">&times;</button></span>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-card collapsible">
                <h4>SEO {% if ai_enabled %}<button type="button" class="btn-ai-suggest" onclick="aiSuggestMeta()" title="AI Suggest Meta">✨ Suggest</button>{% endif %}</h4>
                <div class="form-group">
                    <label for="meta_title">Meta Title</label>
                    <input type="text" id="meta_title" name="meta_title" value="{% if post %}{{ post.meta_title | default(value="") }}{% endif %}" maxlength="60">
                    <span class="char-count">0/60</span>
                </div>
                <div class="form-group">
                    <label for="meta_description">Meta Description</label>
                    <textarea id="meta_description" name="meta_description" rows="2" maxlength="160">{% if post %}{{ post.meta_description | default(value="") }}{% endif %}</textarea>
                    <span class="char-count">0/160</span>
                </div>
                {% if post %}
                <div class="form-group" style="margin-top:12px">
                    <button type="button" id="seo-check-btn" class="btn btn-secondary" style="width:100%" onclick="runSeoCheck('post', {{ post.id }})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        SEO Check
                    </button>
                    <div id="seo-results" style="display:none;margin-top:10px"></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</form>

{% include "admin/media_modal" %}
{% endblock content %}

{% block scripts %}
<script src="/static/js/tinymce/tinymce.min.js"></script>
<script>
    tinymce.init({
        selector: '#content',
        plugins: 'lists advlist table link image media autolink code codesample searchreplace wordcount autoresize fullscreen quickbars charmap emoticons anchor visualblocks preview directionality',
        toolbar: '{% if ai_enabled %}aiassist | {% endif %}undo redo | blocks | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media medialibrary table | codesample blockquote charmap emoticons | searchreplace visualblocks code fullscreen | ltr rtl | removeformat',
        menubar: 'file edit view insert format tools table',
        height: 1000,
        min_height: 700,
        autoresize_bottom_margin: 50,
        skin: '{% if settings.admin_theme | default(value="dark") == "dark" %}oxide-dark{% else %}oxide{% endif %}',
        content_css: false,
        content_style: {% if settings.admin_theme | default(value='dark') == 'dark' %}'body { background: #2A282F; color: #f0f0f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 15px; line-height: 1.7; padding: 12px 16px; } a { color: #E8913A; } pre { background: #262830; border: 1px solid #363840; border-radius: 6px; padding: 12px; } code { background: #262830; padding: 2px 5px; border-radius: 3px; font-size: 0.9em; } table { border-collapse: collapse; } table td, table th { border: 1px solid #363840; padding: 8px; } blockquote { border-left: 3px solid #E8913A; margin-left: 0; padding-left: 16px; color: #9ca3af; } img { max-width: 100%; height: auto; border-radius: 6px; }'{% else %}'body { background: #fff; color: #2a2a2a; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 15px; line-height: 1.7; padding: 12px 16px; } a { color: #E8913A; } pre { background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; } code { background: #f5f5f5; padding: 2px 5px; border-radius: 3px; font-size: 0.9em; } table { border-collapse: collapse; } table td, table th { border: 1px solid #e0e0e0; padding: 8px; } blockquote { border-left: 3px solid #E8913A; margin-left: 0; padding-left: 16px; color: #777; } img { max-width: 100%; height: auto; border-radius: 6px; }'{% endif %},
        branding: false,
        promotion: false,
        images_upload_url: '/{{ admin_slug }}/upload/image',
        images_upload_credentials: true,
        automatic_uploads: true,
        images_reuse_filename: false,
        file_picker_types: 'image',
        image_advtab: true,
        media_live_embeds: true,
        link_default_target: '_blank',
        codesample_languages: [
            { text: 'HTML/XML', value: 'markup' },
            { text: 'JavaScript', value: 'javascript' },
            { text: 'CSS', value: 'css' },
            { text: 'Python', value: 'python' },
            { text: 'Rust', value: 'rust' },
            { text: 'Go', value: 'go' },
            { text: 'Bash', value: 'bash' },
            { text: 'SQL', value: 'sql' },
            { text: 'JSON', value: 'json' },
            { text: 'YAML', value: 'yaml' },
            { text: 'TypeScript', value: 'typescript' },
            { text: 'PHP', value: 'php' },
            { text: 'Ruby', value: 'ruby' },
            { text: 'Java', value: 'java' },
            { text: 'C/C++', value: 'c' },
        ],
        quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote{% if ai_enabled %} | aiassist{% endif %}',
        quickbars_insert_toolbar: 'image media table hr codesample',
        setup: function(editor) {
            editor.on('init', function() {
                var form = document.getElementById('post-form');
                form.addEventListener('submit', function() {
                    editor.save();
                });
            });
            editor.ui.registry.addButton('medialibrary', {
                icon: 'gallery',
                tooltip: 'Browse Media Library',
                onAction: function() {
                    window.openMediaLibrary(function(file) {
                        if (file.is_video) {
                            editor.insertContent('<video src="' + file.url + '" controls style="max-width:100%"></video>');
                        } else {
                            editor.insertContent('<img src="' + file.url + '" alt="' + file.name + '">');
                        }
                    });
                }
            });
            {% if ai_enabled %}
            editor.ui.registry.addMenuButton('aiassist', {
                text: '✨ AI',
                fetch: function(callback) {
                    var items = [
                        {type:'menuitem', text:'✨ Suggest Content', onAction: function(){ aiSuggestContent(editor); }},
                        {type:'separator'},
                        {type:'menuitem', text:'Expand', onAction: function(){ aiInlineAssist(editor, 'expand'); }},
                        {type:'menuitem', text:'Rewrite', onAction: function(){ aiInlineAssist(editor, 'rewrite'); }},
                        {type:'menuitem', text:'Summarise', onAction: function(){ aiInlineAssist(editor, 'summarise'); }},
                        {type:'menuitem', text:'Continue', onAction: function(){ aiInlineAssist(editor, 'continue'); }},
                        {type:'menuitem', text:'More Formal', onAction: function(){ aiInlineAssist(editor, 'formal'); }},
                        {type:'menuitem', text:'More Casual', onAction: function(){ aiInlineAssist(editor, 'casual'); }},
                    ];
                    callback(items);
                }
            });
            {% endif %}
        }
    });

    // Toast helper
    function showToast(msg, color) {
        var t = document.createElement('div');
        t.textContent = msg;
        t.style.cssText = 'position:fixed;top:20px;right:20px;background:' + (color || 'var(--danger,#ef4444)') + ';color:#fff;padding:10px 20px;border-radius:6px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:opacity .4s';
        document.body.appendChild(t);
        setTimeout(function(){ t.style.opacity='0'; }, 3000);
        setTimeout(function(){ t.remove(); }, 3500);
    }

    // Allowed image types from settings
    var allowedTypes = '{{ settings.images_allowed_types | default(value="jpg,jpeg,png,gif,webp,svg,tiff") }}'.toLowerCase().split(',').map(function(s){ return s.trim(); });

    function isAllowedFile(file) {
        var name = file.name.toLowerCase();
        var ext = name.split('.').pop();
        return allowedTypes.indexOf(ext) !== -1;
    }

    // Inline category creation
    function addCategory() {
        var input = document.getElementById('new-cat-name');
        var name = input.value.trim();
        if (!name) return;
        input.disabled = true;
        fetch('/{{ admin_slug }}/api/categories/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name, type: 'post'})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                var list = document.getElementById('category-list');
                var label = document.createElement('label');
                label.className = 'checkbox-item';
                var _esc = function(s){ var d=document.createElement('div');d.textContent=s;return d.innerHTML; };
                label.innerHTML = '<input type="checkbox" name="category_ids" value="' + parseInt(data.id) + '" checked> ' + _esc(data.name);
                list.appendChild(label);
                input.value = '';
            } else {
                showToast(data.error || 'Failed to create category');
            }
        })
        .catch(function() { showToast('Failed to create category'); })
        .finally(function() { input.disabled = false; input.focus(); });
    }
    document.getElementById('new-cat-name').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); addCategory(); }
    });

    // Auto-generate slug from title
    document.getElementById('title').addEventListener('input', function() {
        const slug = document.getElementById('slug');
        if (!slug.dataset.manual) {
            slug.value = this.value.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }
    });
    document.getElementById('slug').addEventListener('input', function() {
        this.dataset.manual = 'true';
    });

    // Auto-schedule: if publish date is in the future, change status to scheduled
    document.getElementById('btn-publish').addEventListener('click', function(e) {
        var dt = document.getElementById('published_at').value;
        if (dt && new Date(dt) > new Date()) {
            this.value = 'scheduled';
        }
    });

    // ── Tag input handling ──
    (function() {
        var input = document.getElementById('tag-input-field');
        var list = document.getElementById('tag-list');
        var hidden = document.getElementById('tag-names-hidden');

        function addTagPill(name) {
            name = name.trim();
            if (!name) return;
            var exists = false;
            list.querySelectorAll('.tag-pill').forEach(function(p) {
                if ((p.dataset.tagName || '').toLowerCase() === name.toLowerCase()) exists = true;
            });
            if (exists) return;
            var pill = document.createElement('span');
            pill.className = 'tag-pill';
            pill.dataset.tagName = name;
            var _escT = function(s){ var d=document.createElement('div');d.textContent=s;return d.innerHTML; };
            pill.innerHTML = _escT(name) + ' <button type="button" class="tag-remove">&times;</button>';
            list.appendChild(pill);
        }

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addTagPill(this.value.replace(/,/g, ''));
                this.value = '';
            }
        });

        list.addEventListener('click', function(e) {
            if (e.target.classList.contains('tag-remove') || e.target.closest('.tag-remove')) {
                var pill = e.target.closest('.tag-pill');
                if (pill) pill.remove();
            }
        });

        var form = input.closest('form');
        if (form) {
            form.addEventListener('submit', function() {
                var names = [];
                list.querySelectorAll('.tag-pill').forEach(function(p) {
                    var n = p.dataset.tagName || p.textContent.replace('\u00d7','').trim();
                    if (n) names.push(n);
                });
                hidden.value = names.join(',');
            });
        }

        window.addTagPill = addTagPill;
    })();

    // Character counters
    document.querySelectorAll('[maxlength]').forEach(el => {
        const counter = el.parentElement.querySelector('.char-count');
        if (counter) {
            const update = () => counter.textContent = el.value.length + '/' + el.maxLength;
            el.addEventListener('input', update);
            update();
        }
    });

    // Featured image dropzone
    (function(){
        var zone = document.getElementById('featured-zone');
        var fileInput = document.getElementById('featured-file');
        var placeholder = document.getElementById('featured-placeholder');
        var preview = document.getElementById('featured-preview');
        var clearBtn = document.getElementById('featured-clear');
        var uploadedPath = document.getElementById('featured-uploaded-path');
        var placeholderOriginal = placeholder.innerHTML;

        function ajaxUploadHeic(file) {
            var _escF = function(s){ var d=document.createElement('div');d.textContent=s;return d.innerHTML; };
            placeholder.innerHTML = '<span style="font-size:13px;color:var(--text-secondary)">Converting ' + _escF(file.name) + '…</span>';
            placeholder.style.display = '';
            preview.style.display = 'none';
            zone.classList.add('has-image');

            var fd = new FormData();
            fd.append('file', file);
            fetch('/{{ admin_slug }}/upload/image', { method: 'POST', body: fd })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.location) {
                        preview.src = data.location;
                        preview.style.display = '';
                        placeholder.style.display = 'none';
                        uploadedPath.value = data.location.replace('/uploads/', '');
                        fileInput.value = '';
                    } else {
                        showToast(data.error || 'Upload failed');
                        zone.classList.remove('has-image');
                        placeholder.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 16v-8m-4 4l4-4 4 4"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Drop image or click to browse</span>';
                    }
                })
                .catch(function() {
                    showToast('Upload failed');
                    zone.classList.remove('has-image');
                    placeholder.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 16v-8m-4 4l4-4 4 4"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Drop image or click to browse</span>';
                });
        }

        function showPreview(file) {
            if (!file) return;
            if (!isAllowedFile(file)) {
                showToast('File type not allowed. Accepted: ' + allowedTypes.join(', '));
                fileInput.value = '';
                return;
            }
            uploadedPath.value = '';
            var ext = file.name.toLowerCase().split('.').pop();
            if (ext === 'heic' || ext === 'heif') {
                ajaxUploadHeic(file);
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = '';
                placeholder.style.display = 'none';
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        zone.addEventListener('click', function(e) {
            if (e.target === clearBtn || e.target.closest('.drop-clear')) return;
            fileInput.click();
        });
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) showPreview(this.files[0]);
        });
        zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', function() { zone.classList.remove('dragover'); });
        zone.addEventListener('drop', function(e) {
            e.preventDefault(); zone.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                if (!isAllowedFile(e.dataTransfer.files[0])) {
                    showToast('File type not allowed. Accepted: ' + allowedTypes.join(', '));
                    return;
                }
                fileInput.files = e.dataTransfer.files;
                showPreview(e.dataTransfer.files[0]);
            }
        });
        clearBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.value = '';
            uploadedPath.value = '';
            preview.style.display = 'none';
            preview.src = '';
            placeholder.innerHTML = placeholderOriginal;
            placeholder.style.display = '';
            zone.classList.remove('has-image');
        });
    })();

    // Browse Media Library for featured image
    document.getElementById('featured-browse-ml').addEventListener('click', function(e) {
        e.preventDefault();
        window.openMediaLibrary(function(file) {
            var zone = document.getElementById('featured-zone');
            var placeholder = document.getElementById('featured-placeholder');
            var preview = document.getElementById('featured-preview');
            var uploadedPath = document.getElementById('featured-uploaded-path');
            var fileInput = document.getElementById('featured-file');
            fileInput.value = '';
            uploadedPath.value = file.path;
            preview.src = file.url;
            preview.style.display = '';
            placeholder.style.display = 'none';
            zone.classList.add('has-image');
        });
    });

    // AI Suggest functions
    {% if ai_enabled %}
    var AI_HAS_VISION = {{ ai_has_vision | default(value=false) }};
    function aiToast(msg, type) {
        var el = document.createElement('div');
        el.className = 'ai-toast ai-toast-' + (type || 'info');
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(function() { el.style.opacity = '0'; el.style.transition = 'opacity 0.3s'; setTimeout(function() { el.remove(); }, 300); }, 3500);
    }
    function fileToBase64(file) {
        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function() { resolve(reader.result.split(',')[1]); };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    function imgSrcToBase64(imgEl) {
        return new Promise(function(resolve) {
            if (!imgEl || !imgEl.src || imgEl.style.display === 'none') { resolve(null); return; }
            var img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                var c = document.createElement('canvas');
                c.width = Math.min(img.width, 1024);
                c.height = Math.round(img.height * (c.width / img.width));
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                resolve(c.toDataURL('image/jpeg', 0.8).split(',')[1]);
            };
            img.onerror = function() { resolve(null); };
            img.src = imgEl.src;
        });
    }
    function getFeaturedImageBase64() {
        return new Promise(function(resolve) {
            var fileInput = document.getElementById('featured-file');
            if (fileInput && fileInput.files && fileInput.files[0]) {
                fileToBase64(fileInput.files[0]).then(resolve).catch(function() { resolve(null); });
            } else {
                var preview = document.getElementById('featured-preview');
                if (preview && preview.src && preview.style.display !== 'none') {
                    imgSrcToBase64(preview).then(resolve);
                } else {
                    resolve(null);
                }
            }
        });
    }
    function checkVision(imgB64) {
        if (imgB64 && !AI_HAS_VISION) {
            aiToast('Image analysis requires Ollama (with llava), OpenAI, or Gemini. Enable one in Settings → AI.', 'info');
            return null;
        }
        return imgB64;
    }
    function aiSuggestTitleOpen() {
        var excerpt = document.getElementById('excerpt').value || '';
        getFeaturedImageBase64().then(function(imgB64) {
            imgB64 = checkVision(imgB64);
            if (!excerpt && !imgB64) {
                aiToast('Enter an excerpt or upload a featured image first', 'info');
                return;
            }
            var body = {};
            if (excerpt) body.description = excerpt;
            if (imgB64) body.image_base64 = imgB64;
            aiCall('/{{ admin_slug }}/api/ai/suggest-title', body, function(data) {
                if (data.title) {
                    document.getElementById('title').value = data.title;
                    document.getElementById('slug').value = data.title.toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-');
                    document.getElementById('slug').dataset.manual = 'true';
                }
            });
        });
    }
    function aiSuggestMeta() {
        var title = document.getElementById('title').value;
        if (!title) { aiToast('Enter a title or upload a featured image first', 'info'); return; }
        var excerpt = document.getElementById('excerpt').value || '';
        if (!excerpt && tinymce.get('content')) {
            excerpt = tinymce.get('content').getContent({format:'text'}).substring(0, 500);
        }
        getFeaturedImageBase64().then(function(imgB64) {
            imgB64 = checkVision(imgB64);
            var body = {title: title, content_excerpt: excerpt, content_type: 'post'};
            if (imgB64) body.image_base64 = imgB64;
            aiCall('/{{ admin_slug }}/api/ai/suggest-meta', body, function(data) {
                if (data.meta_title) { document.getElementById('meta_title').value = data.meta_title; document.getElementById('meta_title').dispatchEvent(new Event('input')); }
                if (data.meta_description) { document.getElementById('meta_description').value = data.meta_description; document.getElementById('meta_description').dispatchEvent(new Event('input')); }
            });
        });
    }
    function aiSuggestTags() {
        var title = document.getElementById('title').value;
        if (!title) { aiToast('Enter a title or upload a featured image first', 'info'); return; }
        var excerpt = '';
        if (tinymce.get('content')) { excerpt = tinymce.get('content').getContent({format:'text'}).substring(0, 500); }
        getFeaturedImageBase64().then(function(imgB64) {
            imgB64 = checkVision(imgB64);
            var body = {title: title, content_excerpt: excerpt};
            if (imgB64) body.image_base64 = imgB64;
            aiCall('/{{ admin_slug }}/api/ai/suggest-tags', body, function(data) {
                if (data.tags && data.tags.length) {
                    data.tags.forEach(function(t) { if (window.addTagPill) window.addTagPill(t); });
                }
            });
        });
    }
    function aiSuggestCategory() {
        var title = document.getElementById('title').value;
        getFeaturedImageBase64().then(function(imgB64) {
            imgB64 = checkVision(imgB64);
            if (!title && !imgB64) {
                aiToast('Enter a title or upload a featured image first', 'info');
                return;
            }
            var excerpt = '';
            if (tinymce.get('content')) { excerpt = tinymce.get('content').getContent({format:'text'}).substring(0, 500); }
            var body = {title: title || '', content_excerpt: excerpt, content_type: 'post'};
            if (imgB64) body.image_base64 = imgB64;
            aiCall('/{{ admin_slug }}/api/ai/suggest-categories', body, function(data) {
                if (data.categories && data.categories.length) {
                    aiApplyCategories(data.categories);
                }
            });
        });
    }
    function aiApplyCategories(catNames) {
        var checkboxes = document.querySelectorAll('#category-list input[type="checkbox"]');
        var existingNames = {};
        checkboxes.forEach(function(cb) {
            var label = cb.parentElement.textContent.trim();
            existingNames[label.toLowerCase()] = cb;
        });
        catNames.forEach(function(name) {
            var key = name.toLowerCase().trim();
            if (existingNames[key]) {
                existingNames[key].checked = true;
            } else {
                // Add as new category via the existing addCategory mechanism
                var inp = document.getElementById('new-cat-name');
                if (inp) {
                    inp.value = name;
                    if (typeof addCategory === 'function') addCategory();
                }
            }
        });
    }
    function aiApplyAll(data) {
        if (data.title) {
            document.getElementById('title').value = data.title;
        }
        if (data.slug) {
            document.getElementById('slug').value = data.slug;
            document.getElementById('slug').dataset.manual = 'true';
        } else if (data.title) {
            document.getElementById('slug').value = data.title.toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-');
            document.getElementById('slug').dataset.manual = 'true';
        }
        if (data.description_html && tinymce.get('content')) {
            tinymce.get('content').setContent(data.description_html);
        }
        if (data.tags && data.tags.length) {
            data.tags.forEach(function(t) { if (window.addTagPill) window.addTagPill(t); });
        }
        if (data.categories && data.categories.length) {
            aiApplyCategories(data.categories);
        }
        if (data.meta_title) {
            document.getElementById('meta_title').value = data.meta_title;
            document.getElementById('meta_title').dispatchEvent(new Event('input'));
        }
        if (data.meta_description) {
            document.getElementById('meta_description').value = data.meta_description;
            document.getElementById('meta_description').dispatchEvent(new Event('input'));
        }
    }
    function aiSuggestAll() {
        var title = document.getElementById('title').value;
        var btn = document.getElementById('btn-suggest-all');
        getFeaturedImageBase64().then(function(imgB64) {
            imgB64 = checkVision(imgB64);
            if (!title && !imgB64) {
                aiToast('Enter a title or upload a featured image first', 'info');
                return;
            }
            btn.disabled = true; btn.textContent = 'Generating…';
            var body = {title: title || '', content_type: 'post'};
            if (imgB64) body.image_base64 = imgB64;
            aiCall('/{{ admin_slug }}/api/ai/suggest-all', body, function(data) {
                aiApplyAll(data);
                aiToast('All fields populated!', 'info');
            }, function() { btn.disabled = false; btn.textContent = '✨ Suggest All'; });
        });
    }
    function aiSuggestContent(editor) {
        var title = document.getElementById('title').value;
        getFeaturedImageBase64().then(function(imgB64) {
            imgB64 = checkVision(imgB64);
            if (!title && !imgB64) {
                aiToast('Enter a title or upload a featured image first', 'info');
                return;
            }
            editor.setProgressState(true);
            var body = {title: title || 'Untitled', content_type: 'post'};
            if (imgB64) body.image_base64 = imgB64;
            aiCall('/{{ admin_slug }}/api/ai/suggest-content', body, function(data) {
                if (data.html) { editor.setContent(data.html); }
                editor.setProgressState(false);
            }, function() { editor.setProgressState(false); });
        });
    }
    function aiInlineAssist(editor, action) {
        var selected = editor.selection.getContent();
        if (!selected && action !== 'continue') { aiToast('Select some text first', 'info'); return; }
        if (action === 'continue') {
            selected = editor.getContent({format:'text'}).slice(-500);
        }
        editor.setProgressState(true);
        aiCall('/{{ admin_slug }}/api/ai/inline-assist', {action: action, text: selected}, function(data) {
            if (data.html) {
                if (action === 'continue') {
                    editor.selection.select(editor.getBody(), true);
                    editor.selection.collapse(false);
                    editor.insertContent(data.html);
                } else {
                    editor.selection.setContent(data.html);
                }
            }
            editor.setProgressState(false);
        }, function() { editor.setProgressState(false); });
    }
    function aiCall(url, body, onSuccess, onFinally) {
        var btns = document.querySelectorAll('.btn-ai-suggest');
        btns.forEach(function(b) { b.disabled = true; });
        fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.ok) { onSuccess(data); }
                else { aiToast(data.error || 'Unknown error', 'error'); }
            })
            .catch(function(e) { aiToast('AI request failed: ' + e, 'error'); })
            .finally(function() { btns.forEach(function(b) { b.disabled = false; }); if (onFinally) onFinally(); });
    }
    function aiGeneratePost() {
        var desc = document.getElementById('ai-generate-input').value;
        if (!desc) { aiToast('Enter a description for the post', 'info'); return; }
        var btn = document.getElementById('ai-generate-btn');
        btn.disabled = true; btn.textContent = 'Generating…';
        aiCall('/{{ admin_slug }}/api/ai/generate-post', {description: desc}, function(data) {
            if (data.title) document.getElementById('title').value = data.title;
            if (data.title) {
                document.getElementById('slug').value = data.title.toLowerCase().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-');
            }
            if (data.content_html && tinymce.get('content')) {
                tinymce.get('content').setContent(data.content_html);
            }
            if (data.excerpt) document.getElementById('excerpt').value = data.excerpt;
            if (data.tags && data.tags.length) {
                data.tags.forEach(function(t) { if (window.addTagPill) window.addTagPill(t); });
            }
            document.getElementById('ai-generate-section').style.display = 'none';
        }, function() { btn.disabled = false; btn.textContent = '✨ Generate'; });
    }
    {% endif %}

    // SEO Check
    function _escSeo(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function runSeoCheck(type, id) {
        var btn = document.getElementById('seo-check-btn');
        var results = document.getElementById('seo-results');
        btn.disabled = true;
        btn.textContent = 'Checking…';
        fetch('/{{ admin_slug }}/api/seo-check/' + type + '/' + id)
            .then(r => r.json())
            .then(data => {
                if (data.error) { results.innerHTML = '<p style="color:var(--danger)">' + _escSeo(data.error) + '</p>'; results.style.display=''; return; }
                var icons = { pass: '✅', warn: '⚠️', fail: '❌' };
                var colors = { pass: 'var(--success,#22c55e)', warn: 'var(--warning,#f59e0b)', fail: 'var(--danger,#ef4444)' };
                var html = '<div style="text-align:center;margin-bottom:8px"><strong style="font-size:28px;color:' + colors[data.grade==='A'||data.grade==='B'?'pass':data.grade==='C'?'warn':'fail'] + '">' + _escSeo(data.grade) + '</strong><br><span style="font-size:12px;color:var(--text-secondary)">' + _escSeo(data.score + '/' + data.total) + ' checks passed</span></div>';
                html += '<div style="font-size:12px;line-height:1.8">';
                data.checks.forEach(function(c) {
                    html += '<div style="display:flex;gap:6px;align-items:flex-start"><span>' + (icons[c.status] || '') + '</span><div><strong>' + _escSeo(c.check) + '</strong><br><span style="color:var(--text-tertiary)">' + _escSeo(c.message) + '</span></div></div>';
                });
                html += '</div>';
                results.innerHTML = html;
                results.style.display = '';
            })
            .catch(function() { results.innerHTML = '<p style="color:var(--danger)">Failed to run SEO check.</p>'; results.style.display=''; })
            .finally(function() { btn.disabled = false; btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>SEO Check'; });
    }
</script>
<script src="/static/js/flatpickr/flatpickr.min.js"></script>
<script>
    // UTC ↔ local helpers
    function utcToLocal(utcStr) {
        if (!utcStr) return '';
        var d = new Date(utcStr + 'Z');
        if (isNaN(d)) return utcStr;
        var pad = function(n){ return n < 10 ? '0'+n : n; };
        return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());
    }
    function localToUtc(localStr) {
        if (!localStr) return '';
        var d = new Date(localStr);
        if (isNaN(d)) return localStr;
        var pad = function(n){ return n < 10 ? '0'+n : n; };
        return d.getUTCFullYear()+'-'+pad(d.getUTCMonth()+1)+'-'+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+':'+pad(d.getUTCMinutes());
    }
    // Convert server UTC value to local for display
    var pubInput = document.getElementById('published_at');
    if (pubInput.value) { pubInput.value = utcToLocal(pubInput.value); }
    // Convert back to UTC on form submit
    document.getElementById('post-form').addEventListener('submit', function() {
        var pa = document.getElementById('published_at');
        if (pa.value) { pa.value = localToUtc(pa.value); }
    });
    flatpickr('#published_at', {
        enableTime: true,
        dateFormat: 'Y-m-d\\TH:i',
        altInput: true,
        altFormat: 'M j, Y  h:i K',
        time_24hr: false,
        allowInput: true,
    });
    (function() {
        var saved = new URLSearchParams(window.location.search).get('saved');
        if (!saved) return;
        var msgs = { draft: 'Draft saved', scheduled: 'Scheduled for publishing' };
        var colors = { draft: 'var(--success)', scheduled: 'var(--warning,#f59e0b)' };
        var msg = msgs[saved]; if (!msg) return;
        var t = document.createElement('div');
        t.textContent = msg;
        t.style.cssText = 'position:fixed;top:20px;right:20px;background:' + (colors[saved] || 'var(--success)') + ';color:#fff;padding:10px 20px;border-radius:6px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:opacity .4s';
        document.body.appendChild(t);
        setTimeout(function(){ t.style.opacity='0'; }, 2500);
        setTimeout(function(){ t.remove(); }, 3000);
        history.replaceState(null, '', window.location.pathname);
    })();
</script>
{% endblock scripts %}
