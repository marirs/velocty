<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocty Super Admin — System Health</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; min-height: 100vh; }
        .topbar { background: #16213e; padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2a2a4a; }
        .topbar h1 { font-size: 18px; color: #E8913A; }
        .topbar a { color: #888; text-decoration: none; font-size: 13px; }
        .topbar a:hover { color: #e0e0e0; }
        .topbar-nav { display: flex; gap: 20px; align-items: center; }
        .topbar-nav .nav-active { color: #E8913A; font-weight: 600; }
        .container { max-width: 1000px; margin: 32px auto; padding: 0 24px; }
        h2 { font-size: 20px; margin-bottom: 20px; }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .card { background: #16213e; border-radius: 8px; padding: 20px; }
        .card h3 { font-size: 14px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
        .stat-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid #2a2a4a; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #888; }
        .stat-value { font-weight: 600; }
        .ok { color: #22c55e; }
        .warn { color: #eab308; }
        .danger { color: #ef4444; }
        .fs-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .fs-table th { text-align: left; padding: 8px 10px; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; background: #0f3460; }
        .fs-table td { padding: 8px 10px; border-top: 1px solid #2a2a4a; }
        .alert-banner { padding: 10px 16px; border-radius: 6px; font-size: 13px; margin-bottom: 16px; }
        .alert-danger { background: rgba(239,68,68,0.1); color: #ef4444; border: 1px solid rgba(239,68,68,0.25); }
        .alert-warn { background: rgba(234,179,8,0.08); color: #eab308; border: 1px solid rgba(234,179,8,0.2); }
        .alert-warn code, .alert-danger code { background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 3px; font-size: 11px; }
        .sites-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 16px; }
        .sites-table th { text-align: left; padding: 8px 10px; color: #888; font-size: 11px; text-transform: uppercase; background: #0f3460; }
        .sites-table td { padding: 8px 10px; border-top: 1px solid #2a2a4a; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-dot-active { background: #22c55e; }
        .status-dot-suspended { background: #ef4444; }
        .status-dot-maintenance { background: #f59e0b; }
        .tool-item { background: #0f3460; border-radius: 6px; padding: 14px; }
        .tool-btn { padding: 6px 16px; background: #E8913A; color: #fff; border: none; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .tool-btn:hover { background: #D07A2F; }
        .tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tool-btn-danger { background: #dc2626; }
        .tool-btn-danger:hover { background: #b91c1c; }
        .tool-result { margin-top: 8px; font-size: 12px; padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.2s; }
        .tool-result.show { max-height: 200px; overflow-y: auto; padding-top: 6px; }
        .tool-result .ok { color: #22c55e; }
        .tool-result .fail { color: #ef4444; }
        .tool-result .details { color: #888; font-size: 11px; margin-top: 4px; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <div class="topbar">
        <h1>Velocty Super Admin</h1>
        <div class="topbar-nav">
            <a href="/super/">Sites</a>
            <a href="/super/health" class="nav-active">Health</a>
            <a href="/super/settings">Settings</a>
            <a href="/super/logout" style="margin-left:16px;opacity:0.5">Sign Out</a>
        </div>
    </div>
    <div class="container">
        <h2>System Health</h2>

        {% if report.running_as_root %}
        <div class="alert-banner alert-danger">
            <strong>⚠ Running as root!</strong> This is a security risk. Run Velocty as a dedicated non-root user.
        </div>
        {% endif %}

        <div class="health-grid">
            <!-- Disk -->
            <div class="card">
                <h3>Disk</h3>
                <div class="stat-row">
                    <span class="stat-label">Total</span>
                    <span class="stat-value" id="disk-total">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Free</span>
                    <span class="stat-value" id="disk-free">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Uploads</span>
                    <span class="stat-value" id="disk-uploads">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Upload Files</span>
                    <span class="stat-value">{{ report.disk.uploads_file_count }}</span>
                </div>
            </div>

            <!-- Resources -->
            <div class="card">
                <h3>Resources</h3>
                <div class="stat-row">
                    <span class="stat-label">Uptime</span>
                    <span class="stat-value">{{ report.resources.uptime_human }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Memory (RSS)</span>
                    <span class="stat-value" id="mem-value">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">OS</span>
                    <span class="stat-value">{{ report.resources.os }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Process User</span>
                    <span class="stat-value {% if report.running_as_root %}danger{% endif %}">{{ report.process_user }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Version</span>
                    <span class="stat-value">{{ report.resources.rust_version }}</span>
                </div>
            </div>

            <!-- Database -->
            <div class="card">
                <h3>Database</h3>
                <div class="stat-row">
                    <span class="stat-label">Backend</span>
                    <span class="stat-value">{{ report.database.backend | capitalize }}</span>
                </div>
                {% if report.database.backend == "sqlite" %}
                <div class="stat-row">
                    <span class="stat-label">DB Size</span>
                    <span class="stat-value" id="db-size">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">WAL Size</span>
                    <span class="stat-value" id="db-wal">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Fragmentation</span>
                    <span class="stat-value {% if report.database.fragmentation_pct > 10 %}warn{% endif %}">{{ report.database.fragmentation_pct | round(precision=1) }}%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Integrity</span>
                    <span class="stat-value">{% if report.database.integrity_ok %}<span class="ok">✓ OK</span>{% else %}<span class="danger">✗ Issues</span>{% endif %}</span>
                </div>
                {% else %}
                <div class="stat-row">
                    <span class="stat-label">Status</span>
                    <span class="stat-value">{% if report.database.mongo_connected %}<span class="ok">✓ Connected</span>{% else %}<span class="danger">✗ Disconnected</span>{% endif %}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Latency</span>
                    <span class="stat-value {% if report.database.mongo_latency_ms > 100 %}warn{% endif %}">{{ report.database.mongo_latency_ms }} ms</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">URI</span>
                    <span class="stat-value" style="font-size:11px;word-break:break-all">{{ report.database.mongo_uri }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Filesystem -->
        <div class="card" style="margin-bottom:24px">
            <h3>Filesystem</h3>
            <table class="fs-table">
                <thead>
                    <tr><th>Path</th><th>Exists</th><th>Writable</th><th>Owner:Group</th><th>Perms</th><th>Expected</th><th>Status</th></tr>
                </thead>
                <tbody>
                {% for check in report.filesystem %}
                <tr>
                    <td style="color:#888">{{ check.path }}</td>
                    <td>{% if check.exists %}<span class="ok">✓</span>{% else %}<span class="danger">✗</span>{% endif %}</td>
                    <td>{% if check.writable %}<span class="ok">✓</span>{% else %}<span class="danger">✗</span>{% endif %}</td>
                    <td>{% if check.owned_by_root %}<span class="danger" style="font-weight:600">{{ check.owner }}:{{ check.group }}</span>{% else %}<span style="color:#888">{{ check.owner }}:{{ check.group }}</span>{% endif %}</td>
                    <td>{% if check.world_writable %}<span class="danger" style="font-weight:600">{{ check.permissions }}</span>{% elif check.perms_ok %}<span class="ok">{{ check.permissions }}</span>{% else %}<span class="warn">{{ check.permissions }}</span>{% endif %}</td>
                    <td style="color:#888">{{ check.recommended }}</td>
                    <td>{% if check.warning %}<span class="danger">✗</span>{% elif check.exists %}<span class="ok">✓</span>{% else %}<span class="danger">✗</span>{% endif %}</td>
                </tr>
                {% if check.warning %}
                <tr>
                    <td colspan="7" style="padding:4px 10px 8px">
                        <div class="alert-banner alert-warn" style="font-size:11px;margin:0">{{ check.warning }}</div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Sites Overview -->
        <div class="card">
            <h3>Sites Overview</h3>
            {% if sites and sites | length > 0 %}
            <table class="sites-table">
                <thead>
                    <tr><th>Site</th><th>Hostname</th><th>Status</th></tr>
                </thead>
                <tbody>
                {% for site in sites %}
                <tr>
                    <td><strong>{{ site.display_name }}</strong></td>
                    <td style="color:#888">{{ site.hostname }}</td>
                    <td>
                        <span class="status-dot status-dot-{{ site.status }}"></span>
                        {{ site.status | capitalize }}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:#666;text-align:center;padding:20px">No sites configured.</p>
            {% endif %}
        </div>

        <!-- Tools -->
        {% if sites and sites | length > 0 %}
        <div class="card" style="margin-top:24px">
            <h3>Maintenance Tools</h3>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <label style="font-size:13px;color:#888;white-space:nowrap">Target site:</label>
                <select id="tool-site" style="flex:1;padding:8px 12px;border:1px solid #2a2a4a;border-radius:6px;background:#0f3460;color:#e0e0e0;font-size:13px">
                    {% for site in sites %}
                    <option value="{{ site.id }}">{{ site.display_name }} ({{ site.hostname }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="tools-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px">
                {% if report.database.backend == "sqlite" %}
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Integrity Check</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">PRAGMA integrity_check on the site's database.</div>
                    <button class="tool-btn" onclick="runSiteTool('integrity-check', this)">Run Check</button>
                    <div class="tool-result" id="result-integrity-check"></div>
                </div>
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Vacuum</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Compact the database file and reclaim free pages.</div>
                    <button class="tool-btn" onclick="runSiteTool('vacuum', this)">Run Vacuum</button>
                    <div class="tool-result" id="result-vacuum"></div>
                </div>
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">WAL Checkpoint</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Flush WAL to main database and truncate.</div>
                    <button class="tool-btn" onclick="runSiteTool('wal-checkpoint', this)">Checkpoint</button>
                    <div class="tool-result" id="result-wal-checkpoint"></div>
                </div>
                {% endif %}
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Session Cleanup</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Delete expired sessions for the selected site.</div>
                    <button class="tool-btn" onclick="runSiteTool('session-cleanup', this)">Clean Sessions</button>
                    <div class="tool-result" id="result-session-cleanup"></div>
                </div>
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Orphan File Scan</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Find uploads not referenced by any content.</div>
                    <button class="tool-btn" onclick="runSiteTool('orphan-scan', this)">Scan</button>
                    <div class="tool-result" id="result-orphan-scan"></div>
                </div>
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Delete Orphan Files</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Permanently remove orphan files from uploads.</div>
                    <button class="tool-btn tool-btn-danger" onclick="runSiteToolConfirm('orphan-delete', this, 'Delete all orphan files for this site?')">Delete Orphans</button>
                    <div class="tool-result" id="result-orphan-delete"></div>
                </div>
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Unused Tags Cleanup</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Delete tags not associated with any content.</div>
                    <button class="tool-btn" onclick="runSiteToolConfirm('unused-tags', this, 'Delete all unused tags?')">Clean Tags</button>
                    <div class="tool-result" id="result-unused-tags"></div>
                </div>
                <div class="tool-item">
                    <div style="font-size:13px;font-weight:600;margin-bottom:4px">Export Content</div>
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Export all content as JSON for the selected site.</div>
                    <button class="tool-btn" onclick="runSiteTool('export-content', this)">Export JSON</button>
                    <div class="tool-result" id="result-export-content"></div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
    function humanBytes(b) {
        if (b >= 1073741824) return (b / 1073741824).toFixed(1) + ' GB';
        if (b >= 1048576) return (b / 1048576).toFixed(1) + ' MB';
        if (b >= 1024) return (b / 1024).toFixed(1) + ' KB';
        return b + ' B';
    }
    function setText(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; }
    var report = {{ report | json_encode() | safe }};
    setText('disk-total', humanBytes(report.disk.total_bytes));
    setText('disk-free', humanBytes(report.disk.free_bytes));
    setText('disk-uploads', humanBytes(report.disk.uploads_size_bytes));
    setText('db-size', humanBytes(report.database.file_size_bytes));
    setText('db-wal', humanBytes(report.database.wal_size_bytes));
    setText('mem-value', humanBytes(report.resources.memory_rss_bytes));

    // ── Tool runner ──
    async function runSiteTool(tool, btn) {
        var siteId = document.getElementById('tool-site').value;
        var resultEl = document.getElementById('result-' + tool);
        var origLabel = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Running...';
        resultEl.className = 'tool-result';
        resultEl.innerHTML = '';
        try {
            var resp = await fetch('/super/health/tool/' + siteId + '/' + tool, { method: 'POST' });
            var data = await resp.json();
            var cls = data.ok ? 'ok' : 'fail';
            var html = '<span class="' + cls + '">' + (data.ok ? '✓' : '✗') + ' ' + data.message + '</span>';
            if (data.details) html += '<div class="details">' + data.details + '</div>';
            resultEl.innerHTML = html;
            resultEl.className = 'tool-result show';
        } catch (e) {
            resultEl.innerHTML = '<span class="fail">✗ Request failed: ' + e.message + '</span>';
            resultEl.className = 'tool-result show';
        } finally {
            btn.disabled = false;
            btn.textContent = origLabel;
        }
    }

    function runSiteToolConfirm(tool, btn, msg) {
        if (confirm(msg)) runSiteTool(tool, btn);
    }
    </script>
</body>
</html>
